---
// Admin Dashboard
export const prerender = false;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - CheckMyRental</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      color: white;
      font-size: 24px;
    }

    .header h1 span:first-child {
      color: white;
    }

    .header h1 span:last-child {
      color: #e74c3c;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Main Content */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .stat-card .label {
      color: #64748b;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
    }

    .stat-card .value.money {
      color: #10b981;
    }

    .stat-card .value.pending {
      color: #f59e0b;
    }

    /* Sections */
    .section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .section-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-header h2 {
      font-size: 18px;
      color: #1e293b;
    }

    .section-content {
      padding: 24px;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      background: #f8fafc;
      color: #64748b;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    td {
      color: #1e293b;
      font-size: 14px;
    }

    tr:hover {
      background: #f8fafc;
    }

    /* Status Badges */
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-draft {
      background: #f1f5f9;
      color: #64748b;
    }

    .badge-new {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .badge-invoiced {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-archived {
      background: #f1f5f9;
      color: #64748b;
    }

    .badge-sent {
      background: #e0e7ff;
      color: #4338ca;
    }

    .badge-paid {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-overdue {
      background: #fee2e2;
      color: #dc2626;
    }

    .badge-zelle {
      background: #f3e8ff;
      color: #7c3aed;
    }

    .badge-square {
      background: #ecfdf5;
      color: #059669;
    }

    .badge-pending_tenant {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-scheduled {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .badge-completed {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-cancelled {
      background: #f1f5f9;
      color: #64748b;
    }

    .badge-no_show {
      background: #fee2e2;
      color: #dc2626;
    }

    .badge-freq {
      background: #ede9fe;
      color: #6d28d9;
      font-size: 0.7rem;
    }

    /* Zone badges */
    .zone-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-left: 6px;
    }

    .zone-badge.TAMPA { background: #fef3c7; color: #92400e; }
    .zone-badge.NORTH { background: #dbeafe; color: #1e40af; }
    .zone-badge.CENTRAL { background: #dcfce7; color: #166534; }
    .zone-badge.SOUTH { background: #fce7f3; color: #9d174d; }
    .zone-badge.EAST { background: #f3e8ff; color: #6b21a8; }
    .zone-badge.UNKNOWN { background: #f1f5f9; color: #64748b; }

    /* Route card */
    .route-card {
      display: flex;
      gap: 16px;
      padding: 16px;
      border-radius: 8px;
      background: #f8fafc;
      margin-bottom: 12px;
    }

    .route-time {
      font-weight: 600;
      color: #1e293b;
      min-width: 70px;
    }

    .route-details {
      flex: 1;
    }

    .route-address {
      font-weight: 500;
      color: #1e293b;
      margin-bottom: 4px;
    }

    .route-tenant {
      font-size: 13px;
      color: #64748b;
    }

    .route-summary {
      display: flex;
      gap: 24px;
      padding: 16px;
      background: #f0fdf4;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .route-summary.fair {
      background: #fefce8;
    }

    .route-summary.poor {
      background: #fef2f2;
    }

    .route-stat {
      text-align: center;
    }

    .route-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #059669;
    }

    .route-summary.fair .route-stat-value {
      color: #ca8a04;
    }

    .route-summary.poor .route-stat-value {
      color: #dc2626;
    }

    .route-stat-label {
      font-size: 12px;
      color: #64748b;
    }

    .navigate-all-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #2563eb;
      color: #fff;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.2s;
    }

    .navigate-all-btn:hover {
      background: #1d4ed8;
    }

    .route-nav-link {
      display: inline-flex;
      align-items: center;
      margin-left: 6px;
      color: #2563eb;
      text-decoration: none;
      vertical-align: middle;
    }

    .route-nav-link:hover {
      color: #1d4ed8;
    }

    .no-route {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }

    /* Action buttons in table */
    .table-actions {
      display: flex;
      gap: 8px;
    }

    .table-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .table-btn-primary {
      background: #e74c3c;
      color: white;
    }

    .table-btn-primary:hover {
      background: #c0392b;
    }

    .table-btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .table-btn-secondary:hover {
      background: #d1d5db;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 16px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
    }

    .tab {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #64748b;
      transition: all 0.2s;
    }

    .tab.active {
      background: #e74c3c;
      color: white;
    }

    .tab:hover:not(.active) {
      background: #f1f5f9;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.3s;
    }

    .modal-overlay.show .modal {
      transform: scale(1);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 18px;
      color: #1e293b;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #64748b;
      padding: 4px;
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #374151;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      background-color: #fff;
      color: #1e293b;
    }

    .form-group select option,
    .property-type option {
      background-color: #fff;
      color: #1e293b;
    }

    .property-type {
      background-color: #fff;
      color: #1e293b;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #e74c3c;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Report Charts */
    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .report-card {
      background: #f8fafc;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }

    .report-card .report-value {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
    }

    .report-card .report-label {
      font-size: 13px;
      color: #64748b;
      margin-top: 4px;
    }

    .bar-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bar-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .bar-label {
      min-width: 80px;
      font-size: 13px;
      color: #64748b;
      text-align: right;
    }

    .bar-track {
      flex: 1;
      height: 28px;
      background: #f1f5f9;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      height: 100%;
      border-radius: 6px;
      display: flex;
      align-items: center;
      padding: 0 10px;
      font-size: 12px;
      font-weight: 600;
      color: white;
      min-width: fit-content;
      transition: width 0.5s ease;
    }

    .bar-amount {
      min-width: 80px;
      font-size: 13px;
      font-weight: 600;
      color: #1e293b;
      text-align: right;
    }

    /* Search Bar */
    .search-bar {
      margin-bottom: 24px;
      position: relative;
    }

    .search-bar input {
      width: 100%;
      padding: 14px 20px 14px 44px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      background: white;
      color: #1e293b;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .search-bar input:focus {
      outline: none;
      border-color: #e74c3c;
      box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
    }

    .search-bar svg {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
    }

    .search-bar .clear-search {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      font-size: 18px;
      display: none;
    }

    .search-bar .clear-search.visible {
      display: block;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
        text-align: center;
      }

      .header-actions {
        flex-wrap: wrap;
        justify-content: center;
      }

      .main {
        padding: 12px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .section-header {
        flex-direction: column;
        gap: 12px;
        align-items: flex-start;
      }

      .tabs {
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
        width: 100%;
      }

      .tab {
        padding: 6px 12px;
        font-size: 13px;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 8px 6px;
      }

      .table-actions {
        flex-direction: column;
        gap: 4px;
      }

      .table-btn {
        font-size: 11px;
        padding: 5px 8px;
      }

      .modal {
        max-width: 100%;
        max-height: 100vh;
        border-radius: 0;
        margin: 0;
      }

      .report-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .bar-label {
        min-width: 60px;
        font-size: 11px;
      }

      .bar-amount {
        min-width: 60px;
        font-size: 11px;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-card .value {
        font-size: 24px;
      }

      .header h1 {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1><span>CheckMy</span><span>Rental</span> <span style="font-weight: 400; font-size: 16px; margin-left: 10px;">Admin</span></h1>
    <div class="header-actions">
      <a href="/admin/availability" class="btn btn-secondary">Availability</a>
      <button class="btn btn-primary" onclick="openCreateInvoiceModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Create Invoice
      </button>
      <button class="btn btn-secondary" onclick="logout()">Logout</button>
    </div>
  </header>

  <main class="main">
    <!-- Stats -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="label">New Inquiries</div>
        <div class="value" id="stat-new-inquiries">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Invoices</div>
        <div class="value" id="stat-total-invoices">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Paid Invoices</div>
        <div class="value money" id="stat-paid-invoices">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Pending Amount</div>
        <div class="value pending" id="stat-pending-amount">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Pending Bookings</div>
        <div class="value" id="stat-pending-bookings">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Scheduled This Week</div>
        <div class="value" id="stat-scheduled-week">-</div>
      </div>
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input type="search" id="global-search" placeholder="Search by name, email, phone, address, invoice #...">
      <button class="clear-search" id="clear-search" onclick="clearSearch()">&times;</button>
    </div>

    <!-- Today's Route Section -->
    <section class="section" id="route-section">
      <div class="section-header">
        <h2>Today's Route</h2>
        <div class="tabs" id="route-date-tabs">
          <button class="tab active" data-date="today">Today</button>
          <button class="tab" data-date="tomorrow">Tomorrow</button>
        </div>
      </div>
      <div class="section-content">
        <div id="route-summary"></div>
        <div id="route-list">
          <div class="no-route"><p>No scheduled inspections for today's route</p></div>
        </div>
      </div>
    </section>

    <!-- Inquiries Section -->
    <section class="section">
      <div class="section-header">
        <h2>Inquiries</h2>
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="tabs">
            <button class="tab active" data-filter="new">New</button>
            <button class="tab" data-filter="invoiced">Invoiced</button>
            <button class="tab" data-filter="archived">Archived</button>
            <button class="tab" data-filter="all">All</button>
          </div>
          <button class="table-btn table-btn-secondary" onclick="exportInquiries()" title="Export CSV">Export</button>
        </div>
      </div>
      <div class="section-content">
        <div class="table-container">
          <table id="inquiries-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Customer</th>
                <th>Properties</th>
                <th>Total</th>
                <th>Payment Pref.</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="inquiries-tbody">
              <tr><td colspan="7" class="empty-state"><p>No inquiries found</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Invoices Section -->
    <section class="section">
      <div class="section-header">
        <h2>Invoices</h2>
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="tabs">
            <button class="tab active" data-filter="pending">Pending</button>
            <button class="tab" data-filter="paid">Paid</button>
            <button class="tab" data-filter="all">All</button>
          </div>
          <button class="table-btn table-btn-secondary" onclick="exportInvoices()" title="Export CSV">Export</button>
        </div>
      </div>
      <div class="section-content">
        <div class="table-container">
          <div id="bulk-actions" style="display: none; padding: 12px 0; margin-bottom: 8px;">
            <button class="table-btn table-btn-primary" onclick="bulkMarkPaid()" id="bulk-paid-btn">Mark Selected as Paid</button>
          </div>
          <table id="invoices-table">
            <thead>
              <tr>
                <th style="width: 40px;"><input type="checkbox" id="select-all-invoices" onchange="toggleAllInvoices(this)"></th>
                <th>Invoice #</th>
                <th>Date</th>
                <th>Customer</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="invoices-tbody">
              <tr><td colspan="8" class="empty-state"><p>No invoices found</p></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Bookings Section -->
    <section class="section">
      <div class="section-header">
        <h2>Tenant Bookings <span id="locks-badge" style="display: none; background: #fef3c7; color: #92400e; font-size: 12px; padding: 2px 8px; border-radius: 10px; font-weight: 600; cursor: pointer; margin-left: 8px;" onclick="toggleLocksPanel()"></span></h2>
        <div style="display: flex; align-items: center; gap: 12px;">
          <div class="tabs" id="bookings-tabs">
            <button class="tab active" data-filter="pending_tenant">Pending</button>
            <button class="tab" data-filter="scheduled">Scheduled</button>
            <button class="tab" data-filter="all">All</button>
          </div>
          <button class="table-btn table-btn-secondary" onclick="exportBookings()" title="Export CSV">Export</button>
        </div>
      </div>
      <div class="section-content">
        <div class="table-container">
          <table id="bookings-table">
            <thead>
              <tr>
                <th>Date/Time</th>
                <th>Property</th>
                <th>Tenant</th>
                <th>Landlord</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="bookings-tbody">
              <tr><td colspan="6" class="empty-state"><p>No bookings found</p></td></tr>
            </tbody>
          </table>
        <!-- Slot Locks Panel -->
        <div id="locks-panel" style="display: none; padding: 16px 24px; border-top: 1px solid #e5e7eb; background: #fffbeb;">
          <h4 style="margin-bottom: 12px; color: #92400e; font-size: 14px;">Active Slot Locks</h4>
          <div id="locks-list"></div>
        </div>
        </div>
      </div>
    </section>

    <!-- Reports Section -->
    <section class="section">
      <div class="section-header">
        <h2>Reports</h2>
        <div class="tabs" id="reports-tabs">
          <button class="tab active" data-report="revenue">Revenue</button>
          <button class="tab" data-report="methods">Payment Methods</button>
          <button class="tab" data-report="zones">Zones</button>
          <button class="tab" data-report="overview">Overview</button>
        </div>
      </div>
      <div class="section-content" id="reports-content">
        <div class="empty-state"><p>No report data available</p></div>
      </div>
    </section>
  </main>

  <!-- Create Invoice Modal -->
  <div class="modal-overlay" id="create-invoice-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>Create Invoice</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <form id="invoice-form" onsubmit="submitInvoice(event)">
        <div class="modal-body">
          <!-- Pre-fill from inquiry selector -->
          <div class="form-group">
            <label>From Inquiry (optional)</label>
            <select id="inquiry-select" onchange="prefillFromInquiry()">
              <option value="">-- Enter details manually --</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Customer Name *</label>
              <input type="text" id="customer-name" required>
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="customer-email" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Phone *</label>
              <input type="tel" id="customer-phone" required>
            </div>
            <div class="form-group">
              <label>Payment Method *</label>
              <select id="payment-method" required>
                <option value="zelle">Zelle (No fee)</option>
                <option value="square">Credit/Debit Card (+3% fee)</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Due Date *</label>
            <input type="date" id="due-date" required>
          </div>

          <!-- Properties -->
          <div class="form-group">
            <label>Properties</label>
            <div id="properties-container">
              <!-- Properties will be added here -->
            </div>
            <button type="button" class="table-btn table-btn-secondary" onclick="addProperty()" style="margin-top: 10px;">
              + Add Property
            </button>
          </div>

          <div class="form-group">
            <label>Notes (optional)</label>
            <textarea id="invoice-notes" rows="3" placeholder="Any additional notes..."></textarea>
          </div>

          <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Subtotal:</span>
              <span id="modal-subtotal">$0.00</span>
            </div>
            <div style="display: none; justify-content: space-between; margin-bottom: 8px;" id="fee-row">
              <span>Processing Fee (3%):</span>
              <span id="modal-fee">$0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 18px; color: #e74c3c;">
              <span>Total:</span>
              <span id="modal-total">$0.00</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submit-invoice-btn">Send Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Inquiry Detail Modal -->
  <div class="modal-overlay" id="inquiry-detail-modal"></div>

  <!-- Edit Invoice Modal -->
  <div class="modal-overlay" id="edit-invoice-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>Edit Invoice</h3>
        <button class="modal-close" onclick="closeEditInvoiceModal()">&times;</button>
      </div>
      <form id="edit-invoice-form" onsubmit="submitEditInvoice(event)">
        <div class="modal-body">
          <input type="hidden" id="edit-invoice-id">
          <div class="form-row">
            <div class="form-group">
              <label>Customer Name *</label>
              <input type="text" id="edit-customer-name" required>
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="edit-customer-email" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Phone *</label>
              <input type="tel" id="edit-customer-phone" required>
            </div>
            <div class="form-group">
              <label>Due Date *</label>
              <input type="date" id="edit-due-date" required>
            </div>
          </div>
          <div class="form-group">
            <label>Notes (optional)</label>
            <textarea id="edit-invoice-notes" rows="3" placeholder="Any additional notes..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeEditInvoiceModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="edit-invoice-btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Booking Notes Modal -->
  <div class="modal-overlay" id="booking-notes-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>Booking Notes</h3>
        <button class="modal-close" onclick="closeBookingNotesModal()">&times;</button>
      </div>
      <form id="booking-notes-form" onsubmit="submitBookingNotes(event)">
        <div class="modal-body">
          <input type="hidden" id="booking-notes-id">
          <div id="booking-notes-info" style="margin-bottom: 16px; padding: 12px; background: #f8fafc; border-radius: 8px;"></div>
          <div class="form-group">
            <label>Notes</label>
            <textarea id="booking-notes-text" rows="5" placeholder="Access codes, gate instructions, parking info, inspection observations..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeBookingNotesModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="save-booking-notes-btn">Save Notes</button>
        </div>
      </form>
    </div>
  </div>

  <script is:inline>
    // Auth check
    const token = localStorage.getItem('adminToken');
    if (!token) {
      window.location.href = '/admin/login';
    }

    // Prices
    const PRICES = {
      zelle: { apartment: 70, single_family: 100, multifamily: 165 },
      card: { apartment: 72.33, single_family: 103.20, multifamily: 170.09 }
    };

    // State
    let inquiries = [];
    let invoices = [];
    let bookings = [];
    let propertyCount = 0;
    let slotDuration = 60;
    let searchTerm = '';
    let slotLocks = [];

    // Search handler
    let searchTimeout;
    document.getElementById('global-search').addEventListener('input', function() {
      clearTimeout(searchTimeout);
      const clearBtn = document.getElementById('clear-search');
      clearBtn.classList.toggle('visible', this.value.length > 0);
      searchTimeout = setTimeout(() => {
        searchTerm = this.value.toLowerCase().trim();
        renderAllTables();
      }, 200);
    });

    function clearSearch() {
      document.getElementById('global-search').value = '';
      document.getElementById('clear-search').classList.remove('visible');
      searchTerm = '';
      renderAllTables();
    }

    function renderAllTables() {
      const inquiryTab = document.querySelector('.section:has(#inquiries-table) .tab.active');
      const invoiceTab = document.querySelector('.section:has(#invoices-table) .tab.active');
      const bookingTab = document.querySelector('#bookings-tabs .tab.active');
      renderInquiries(inquiryTab?.dataset.filter || 'new');
      renderInvoices(invoiceTab?.dataset.filter || 'pending');
      renderBookings(bookingTab?.dataset.filter || 'pending_tenant');
    }

    function matchesSearch(item) {
      if (!searchTerm) return true;
      const fields = [
        item.customerName, item.customerEmail, item.customerPhone,
        item.invoiceNumber, item.propertyAddress, item.tenantName,
        item.tenantPhone, item.landlordName, item.landlordEmail
      ];
      // Also check properties array
      if (item.properties) {
        item.properties.forEach(p => {
          fields.push(p.address, p.tenantName, p.tenantPhone);
        });
      }
      return fields.some(f => f && String(f).toLowerCase().includes(searchTerm));
    }

    // Fetch data
    async function fetchData() {
      try {
        // Fetch invoices and inquiries
        const response = await fetch('/api/invoices/list?type=all', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.status === 401) {
          localStorage.removeItem('adminToken');
          window.location.href = '/admin/login';
          return;
        }

        const data = await response.json();

        if (data.stats) {
          document.getElementById('stat-new-inquiries').textContent = data.stats.newInquiries || 0;
          document.getElementById('stat-total-invoices').textContent = data.stats.totalInvoices || 0;
          document.getElementById('stat-paid-invoices').textContent = data.stats.paidInvoices || 0;
          document.getElementById('stat-pending-amount').textContent = '$' + (data.stats.pendingAmount || 0).toFixed(2);
        }

        inquiries = data.inquiries || [];
        invoices = data.invoices || [];

        renderInquiries();
        renderInvoices();
        populateInquirySelect();

        // Fetch bookings
        const bookingsResponse = await fetch('/api/bookings/list?includeLocks=true', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (bookingsResponse.ok) {
          const bookingsData = await bookingsResponse.json();
          bookings = bookingsData.bookings || [];
          slotDuration = bookingsData.slotDuration || 60;
          slotLocks = bookingsData.locks || [];

          if (bookingsData.stats) {
            document.getElementById('stat-pending-bookings').textContent = bookingsData.stats.pendingBookings || 0;
            document.getElementById('stat-scheduled-week').textContent = bookingsData.stats.scheduledThisWeek || 0;
          }

          renderBookings();
          try { renderRoute(0); } catch (e) { console.error('Route render error:', e); }
          renderReports();
          renderSlotLocks();
        }
      } catch (error) {
        console.error('Fetch error:', error);
      }
    }

    // Render inquiries table
    function renderInquiries(filter = 'new') {
      const tbody = document.getElementById('inquiries-tbody');
      let filtered = inquiries;

      if (filter !== 'all') {
        filtered = inquiries.filter(i => i.status === filter);
      }
      filtered = filtered.filter(matchesSearch);

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <p>No ${filter !== 'all' ? filter + ' ' : ''}inquiries found</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filtered.map(inquiry => `
        <tr>
          <td>${new Date(inquiry.createdAt).toLocaleDateString()}</td>
          <td>
            <strong>${inquiry.customerName}</strong><br>
            <small style="color: #64748b;">${inquiry.customerEmail}</small>
          </td>
          <td>${inquiry.properties?.length || 0} properties</td>
          <td>$${(inquiry.total || 0).toFixed(2)}</td>
          <td><span class="badge badge-${inquiry.paymentPreference}">${inquiry.paymentPreference === 'zelle' ? 'Zelle' : 'Card'}</span></td>
          <td><span class="badge badge-${inquiry.status}">${inquiry.status}</span></td>
          <td>
            <div class="table-actions">
              ${inquiry.status === 'new' ? `
                <button class="table-btn table-btn-primary" onclick="createInvoiceFromInquiry('${inquiry.id}')">
                  Create Invoice
                </button>
              ` : ''}
              ${inquiry.status !== 'archived' ? `
                <button class="table-btn table-btn-secondary" onclick="archiveInquiry('${inquiry.id}')">
                  Archive
                </button>
              ` : ''}
              <button class="table-btn table-btn-secondary" onclick="showInquiryDetail('${inquiry.id}')">
                Details
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Render invoices table
    function renderInvoices(filter = 'pending') {
      const tbody = document.getElementById('invoices-tbody');
      let filtered = invoices;

      if (filter === 'pending') {
        filtered = invoices.filter(i => ['draft', 'sent', 'viewed', 'overdue'].includes(i.status));
      } else if (filter === 'paid') {
        filtered = invoices.filter(i => i.status === 'paid');
      }
      filtered = filtered.filter(matchesSearch);

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <p>No ${filter !== 'all' ? filter + ' ' : ''}invoices found</p>
            </td>
          </tr>
        `;
        document.getElementById('bulk-actions').style.display = 'none';
        return;
      }

      tbody.innerHTML = filtered.map(invoice => `
        <tr>
          <td><input type="checkbox" class="invoice-check" value="${invoice.id}" onchange="updateBulkActions()" ${invoice.status === 'paid' || invoice.status === 'cancelled' ? 'disabled' : ''}></td>
          <td><strong>${invoice.invoiceNumber}</strong></td>
          <td>${new Date(invoice.createdAt).toLocaleDateString()}</td>
          <td>
            <strong>${invoice.customerName}</strong><br>
            <small style="color: #64748b;">${invoice.customerEmail}</small>
          </td>
          <td>$${(invoice.total || 0).toFixed(2)}</td>
          <td><span class="badge badge-${invoice.paymentMethod}">${invoice.paymentMethod === 'zelle' ? 'Zelle' : 'Square'}</span></td>
          <td><span class="badge badge-${invoice.status}">${invoice.status}</span></td>
          <td>
            <div class="table-actions">
              ${invoice.status === 'draft' ? `
                <button class="table-btn table-btn-primary" onclick="retrySendInvoice('${invoice.id}')">
                  Retry Send
                </button>
              ` : ''}
              ${invoice.status !== 'paid' && invoice.status !== 'cancelled' ? `
                <button class="table-btn table-btn-primary" onclick="markPaid('${invoice.id}')">
                  Mark Paid
                </button>
                <button class="table-btn table-btn-secondary" onclick="openEditInvoiceModal('${invoice.id}')">
                  Edit
                </button>
                ${['sent', 'viewed', 'overdue'].includes(invoice.status) ? `
                  <button class="table-btn table-btn-secondary" onclick="sendReminder('${invoice.id}')" title="${invoice.lastReminderSentAt ? 'Last sent: ' + new Date(invoice.lastReminderSentAt).toLocaleDateString() : 'No reminder sent yet'}">
                    Remind
                  </button>
                ` : ''}
                <button class="table-btn table-btn-secondary" onclick="cancelInvoice('${invoice.id}')" style="background: #fee2e2; color: #dc2626;">
                  Cancel
                </button>
              ` : ''}
              ${invoice.status === 'paid' ? `
                <button class="table-btn table-btn-secondary" onclick="sendBookingLinks('${invoice.id}')">
                  Send Booking Links
                </button>
              ` : ''}
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Render bookings table
    function renderBookings(filter = 'pending_tenant') {
      const tbody = document.getElementById('bookings-tbody');
      let filtered = bookings;

      if (filter === 'pending_tenant') {
        filtered = bookings.filter(b => b.status === 'pending_tenant');
      } else if (filter === 'scheduled') {
        filtered = bookings.filter(b => b.status === 'scheduled');
      }
      filtered = filtered.filter(matchesSearch);

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <p>No ${filter === 'pending_tenant' ? 'pending ' : filter === 'scheduled' ? 'scheduled ' : ''}bookings found</p>
            </td>
          </tr>
        `;
        return;
      }

      const STATUS_LABELS = {
        pending_tenant: 'Awaiting Tenant',
        scheduled: 'Scheduled',
        completed: 'Completed',
        cancelled: 'Cancelled',
        no_show: 'No Show'
      };

      const FREQ_LABELS = {
        quarterly: 'Quarterly',
        monthly: 'Monthly',
        bimonthly: 'Bi-Monthly',
        weekly: 'Weekly',
        one_time: 'One Time',
        custom: 'Custom',
      };

      tbody.innerHTML = filtered.map(booking => {
        const dateTime = booking.scheduledDate && booking.scheduledTime
          ? `${new Date(booking.scheduledDate + 'T12:00:00').toLocaleDateString()}<br><small>${formatTime(booking.scheduledTime)}</small>`
          : '<span style="color: #94a3b8;">Not scheduled</span>';

        const zone = booking.serviceZone || '';
        const zoneBadge = zone ? `<span class="zone-badge ${zone}">${zone}</span>` : '';

        return `
          <tr>
            <td>${dateTime}</td>
            <td>${booking.propertyAddress}${zoneBadge}</td>
            <td>
              <strong>${booking.tenantName}</strong><br>
              <small style="color: #64748b;">${booking.tenantPhone}</small>
            </td>
            <td>
              <strong>${booking.landlordName}</strong><br>
              <small style="color: #64748b;">${booking.landlordEmail}</small>
            </td>
            <td>
              <span class="badge badge-${booking.status}">${STATUS_LABELS[booking.status] || booking.status}</span>
              ${booking.inspectionFrequency && booking.inspectionFrequency !== 'one_time' ? `<br><span class="badge badge-freq" style="margin-top: 4px;">${FREQ_LABELS[booking.inspectionFrequency] || booking.inspectionFrequency}</span>` : ''}
              ${booking.status === 'pending_tenant' && !booking.smsBookingLinkSentAt ? `<br><span style="color: #f59e0b; font-size: 11px;" title="Booking link SMS was not delivered">&#9888; SMS not sent</span>` : ''}
              ${booking.status === 'scheduled' && !booking.smsConfirmationSentAt ? `<br><span style="color: #f59e0b; font-size: 11px;" title="Confirmation SMS was not delivered">&#9888; SMS not sent</span>` : ''}
            </td>
            <td>
              <div class="table-actions">
                ${booking.status === 'pending_tenant' ? `
                  <button class="table-btn table-btn-secondary" onclick="resendBookingLink('${booking.id}')">
                    Resend Link
                  </button>
                ` : ''}
                ${booking.status === 'scheduled' ? `
                  <button class="table-btn table-btn-primary" onclick="startInspection('${booking.id}')" style="background: #7c3aed;">
                    Inspect
                  </button>
                  <button class="table-btn table-btn-primary" onclick="completeBooking('${booking.id}')">
                    Complete
                  </button>
                  <button class="table-btn table-btn-secondary" onclick="cancelBooking('${booking.id}')">
                    Cancel
                  </button>
                  <button class="table-btn table-btn-secondary" onclick="noShowBooking('${booking.id}')" style="background: #fee2e2; color: #dc2626;">
                    No Show
                  </button>
                  ${!booking.smsConfirmationSentAt ? `
                    <button class="table-btn table-btn-secondary" onclick="retryConfirmationSMS('${booking.id}')" title="Retry sending confirmation SMS">
                      Retry SMS
                    </button>
                  ` : ''}
                ` : ''}
                ${booking.status === 'completed' ? `
                  <button class="table-btn table-btn-secondary" onclick="viewReport('${booking.id}')" style="background: #ede9fe; color: #7c3aed;">
                    Report
                  </button>
                ` : ''}
                <button class="table-btn table-btn-secondary" onclick="openBookingNotesModal('${booking.id}')" title="${booking.notes ? 'Has notes' : 'Add notes'}">
                  ${booking.notes ? 'Notes *' : 'Notes'}
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Format time for display
    function formatTime(timeStr) {
      const [hour, minute] = timeStr.split(':').map(Number);
      const period = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour % 12 || 12;
      return `${displayHour}:${String(minute).padStart(2, '0')} ${period}`;
    }

    // Zone travel time matrix (same as backend)
    const ZONE_TRAVEL_MATRIX = {
      TAMPA: { TAMPA: 20, NORTH: 45, CENTRAL: 35, SOUTH: 45, EAST: 40, UNKNOWN: 60 },
      NORTH: { TAMPA: 45, NORTH: 15, CENTRAL: 25, SOUTH: 45, EAST: 30, UNKNOWN: 45 },
      CENTRAL: { TAMPA: 35, NORTH: 25, CENTRAL: 15, SOUTH: 30, EAST: 20, UNKNOWN: 35 },
      SOUTH: { TAMPA: 45, NORTH: 45, CENTRAL: 30, SOUTH: 15, EAST: 25, UNKNOWN: 40 },
      EAST: { TAMPA: 40, NORTH: 30, CENTRAL: 20, SOUTH: 25, EAST: 15, UNKNOWN: 35 },
      UNKNOWN: { TAMPA: 60, NORTH: 45, CENTRAL: 35, SOUTH: 40, EAST: 35, UNKNOWN: 30 }
    };

    const ZONE_NAMES = {
      TAMPA: 'Tampa / Hillsborough',
      NORTH: 'North Pinellas',
      CENTRAL: 'Central Pinellas',
      SOUTH: 'South Pinellas',
      EAST: 'Mid Pinellas',
      UNKNOWN: 'Unknown Area'
    };

    // Render today's route
    function renderRoute(dateOffset = 0) {
      const targetDate = new Date();
      targetDate.setDate(targetDate.getDate() + dateOffset);
      const targetDateStr = targetDate.toISOString().split('T')[0];

      // Filter scheduled bookings for target date
      const todayBookings = bookings.filter(b =>
        b.status === 'scheduled' &&
        b.scheduledDate === targetDateStr
      ).sort((a, b) => {
        // Sort by time
        const timeA = a.scheduledTime.split(':').map(Number);
        const timeB = b.scheduledTime.split(':').map(Number);
        return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
      });

      const routeSection = document.getElementById('route-section');
      const summaryEl = document.getElementById('route-summary');
      const listEl = document.getElementById('route-list');

      if (todayBookings.length === 0) {
        summaryEl.innerHTML = '';
        listEl.innerHTML = `
          <div class="no-route">
            <p>No inspections scheduled for ${dateOffset === 0 ? 'today' : 'tomorrow'}</p>
          </div>
        `;
        return;
      }

      // Calculate route statistics
      let totalTravel = 0;
      let currentZone = todayBookings[0].serviceZone || 'UNKNOWN';

      for (let i = 0; i < todayBookings.length; i++) {
        const booking = todayBookings[i];
        const zone = booking.serviceZone || 'UNKNOWN';
        if (i > 0) {
          totalTravel += ZONE_TRAVEL_MATRIX[currentZone]?.[zone] || 30;
        }
        currentZone = zone;
      }

      const totalInspectionTime = todayBookings.length * slotDuration;
      const ratio = totalTravel / totalInspectionTime;
      let efficiency = 'good';
      if (ratio >= 1.0) efficiency = 'poor';
      else if (ratio >= 0.5) efficiency = 'fair';

      // Build Google Maps directions URL with all addresses as waypoints
      const addresses = todayBookings.map(b => encodeURIComponent(b.propertyAddress));
      const mapsUrl = addresses.length === 1
        ? `https://www.google.com/maps/dir/?api=1&destination=${addresses[0]}`
        : `https://www.google.com/maps/dir/?api=1&destination=${addresses[addresses.length - 1]}&waypoints=${addresses.slice(0, -1).join('|')}`;

      // Render summary
      summaryEl.innerHTML = `
        <div class="route-summary ${efficiency}">
          <div class="route-stat">
            <div class="route-stat-value">${todayBookings.length}</div>
            <div class="route-stat-label">Inspections</div>
          </div>
          <div class="route-stat">
            <div class="route-stat-value">${totalTravel}</div>
            <div class="route-stat-label">Travel (min)</div>
          </div>
          <div class="route-stat">
            <div class="route-stat-value">${efficiency.charAt(0).toUpperCase() + efficiency.slice(1)}</div>
            <div class="route-stat-label">Efficiency</div>
          </div>
          <div class="route-stat">
            <a href="${mapsUrl}" target="_blank" rel="noopener" class="navigate-all-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg>
              Navigate All
            </a>
          </div>
        </div>
      `;

      // Render route list
      listEl.innerHTML = todayBookings.map((booking, i) => {
        const zone = booking.serviceZone || 'UNKNOWN';
        const zoneName = ZONE_NAMES[zone] || zone;
        const travelFromPrev = i > 0
          ? ZONE_TRAVEL_MATRIX[todayBookings[i-1].serviceZone || 'UNKNOWN']?.[zone] || 30
          : 0;

        const singleMapUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(booking.propertyAddress)}`;

        return `
          <div class="route-card">
            <div class="route-time">${formatTime(booking.scheduledTime)}</div>
            <div class="route-details">
              <div class="route-address">
                ${booking.propertyAddress}
                <span class="zone-badge ${zone}">${zone}</span>
                <a href="${singleMapUrl}" target="_blank" rel="noopener" class="route-nav-link" title="Navigate">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/><circle cx="12" cy="9" r="2.5"/></svg>
                </a>
              </div>
              <div class="route-tenant">
                ${booking.tenantName} - ${booking.tenantPhone}
                ${travelFromPrev > 0 ? `<span style="margin-left: 10px; color: #94a3b8;"> ${travelFromPrev} min drive</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Send booking links for an invoice
    async function sendBookingLinks(invoiceId) {
      if (!confirm('Send booking links to tenants for this invoice?')) return;

      try {
        const response = await fetch('/api/bookings/send-links', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ invoiceId })
        });

        const data = await response.json();

        if (response.ok) {
          alert(data.message || 'Booking links sent!');
          fetchData();
        } else {
          alert('Error: ' + (data.error || 'Failed to send booking links'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Resend booking link
    async function resendBookingLink(bookingId) {
      if (!confirm('Resend booking link to tenant?')) return;

      try {
        const response = await fetch(`/api/bookings/${bookingId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'resend_link' })
        });

        if (response.ok) {
          alert('Booking link sent!');
          fetchData();
        } else {
          const data = await response.json();
          alert('Error: ' + (data.error || 'Failed to resend'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Complete booking
    async function completeBooking(bookingId) {
      if (!confirm('Mark this booking as completed?')) return;

      try {
        const response = await fetch(`/api/bookings/${bookingId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'complete' })
        });

        if (response.ok) {
          fetchData();
        } else {
          alert('Failed to update booking');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Cancel booking
    async function cancelBooking(bookingId) {
      if (!confirm('Cancel this booking?')) return;

      try {
        const response = await fetch(`/api/bookings/${bookingId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'cancel' })
        });

        if (response.ok) {
          fetchData();
        } else {
          alert('Failed to cancel booking');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // No-show booking
    async function noShowBooking(bookingId) {
      if (!confirm('Mark this booking as no-show?')) return;

      try {
        const response = await fetch(`/api/bookings/${bookingId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'no_show' })
        });

        if (response.ok) {
          fetchData();
        } else {
          alert('Failed to mark as no-show');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Retry confirmation SMS
    async function retryConfirmationSMS(bookingId) {
      if (!confirm('Retry sending confirmation SMS to tenant?')) return;
      try {
        const response = await fetch(`/api/bookings/${bookingId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'retry_confirmation_sms' })
        });
        if (response.ok) {
          alert('Confirmation SMS sent successfully!');
          fetchData();
        } else {
          const data = await response.json();
          alert('Error: ' + (data.error || 'Failed to send SMS'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Archive inquiry
    async function archiveInquiry(inquiryId) {
      if (!confirm('Archive this inquiry?')) return;
      try {
        const response = await fetch(`/api/inquiries/${inquiryId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: 'archived' })
        });
        if (response.ok) {
          fetchData();
        } else {
          const data = await response.json();
          alert('Error: ' + (data.error || 'Failed to archive inquiry'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Show inquiry detail modal
    function showInquiryDetail(inquiryId) {
      const inquiry = inquiries.find(i => i.id === inquiryId);
      if (!inquiry) return;

      const FREQ_LABELS = {
        quarterly: 'Quarterly', monthly: 'Monthly', bimonthly: 'Every 2 Months',
        weekly: 'Weekly', one_time: 'One Time', custom: 'Custom Schedule',
      };
      const TIMEFRAME_LABELS = {
        asap: 'As soon as possible', this_week: 'This week', next_week: 'Next week',
        this_month: 'Within this month', flexible: 'Flexible',
      };
      const TYPE_LABELS = {
        apartment: 'Apartment', single_family: 'Single Family Home', multifamily: 'Multifamily Home',
      };

      const propertiesHtml = (inquiry.properties || []).map(p => `
        <div style="padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px;">
          <div style="font-weight: 600;">${TYPE_LABELS[p.type] || p.type}</div>
          <div style="color: #64748b; font-size: 13px;">${p.address}</div>
          ${p.tenantName ? `<div style="font-size: 13px;">Tenant: ${p.tenantName}${p.tenantPhone ? ' (' + p.tenantPhone + ')' : ''}</div>` : ''}
          <div style="font-weight: 500; color: #e74c3c;">$${(p.price || 0).toFixed(2)}</div>
        </div>
      `).join('');

      const detailModal = document.getElementById('inquiry-detail-modal');
      detailModal.innerHTML = `
        <div class="modal">
          <div class="modal-header">
            <h3>Inquiry Details</h3>
            <button class="modal-close" onclick="closeInquiryDetail()">&times;</button>
          </div>
          <div class="modal-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
              <div><strong>Customer:</strong> ${inquiry.customerName}</div>
              <div><strong>Email:</strong> ${inquiry.customerEmail}</div>
              <div><strong>Phone:</strong> ${inquiry.customerPhone}</div>
              <div><strong>Status:</strong> <span class="badge badge-${inquiry.status}">${inquiry.status}</span></div>
              <div><strong>Payment:</strong> ${inquiry.paymentPreference === 'zelle' ? 'Zelle' : 'Card'}</div>
              <div><strong>Total:</strong> $${(inquiry.total || 0).toFixed(2)}</div>
              <div><strong>Timeframe:</strong> ${TIMEFRAME_LABELS[inquiry.preferredTimeframe] || inquiry.preferredTimeframe}</div>
              <div><strong>Frequency:</strong> ${FREQ_LABELS[inquiry.inspectionFrequency] || inquiry.inspectionFrequency}</div>
            </div>
            <h4 style="margin-bottom: 12px;">Properties (${inquiry.properties?.length || 0})</h4>
            ${propertiesHtml}
            ${inquiry.notes ? `<div style="margin-top: 16px;"><strong>Notes:</strong><p style="color: #64748b; margin-top: 4px;">${inquiry.notes}</p></div>` : ''}
            <div style="color: #94a3b8; font-size: 12px; margin-top: 16px;">
              Submitted: ${new Date(inquiry.createdAt).toLocaleString()}
            </div>
          </div>
          <div class="modal-footer">
            ${inquiry.status === 'new' ? `<button class="btn btn-primary" onclick="closeInquiryDetail(); createInvoiceFromInquiry('${inquiry.id}')">Create Invoice</button>` : ''}
            <button class="btn btn-secondary" style="background: #e5e7eb; color: #374151;" onclick="closeInquiryDetail()">Close</button>
          </div>
        </div>
      `;
      detailModal.classList.add('show');
    }

    function closeInquiryDetail() {
      document.getElementById('inquiry-detail-modal').classList.remove('show');
    }

    // Populate inquiry select in modal
    function populateInquirySelect() {
      const select = document.getElementById('inquiry-select');
      const newInquiries = inquiries.filter(i => i.status === 'new');

      select.innerHTML = '<option value="">-- Enter details manually --</option>' +
        newInquiries.map(i => `
          <option value="${i.id}">${i.customerName} - ${i.properties?.length || 0} properties ($${(i.total || 0).toFixed(2)})</option>
        `).join('');
    }

    // Pre-fill form from inquiry
    function prefillFromInquiry() {
      const select = document.getElementById('inquiry-select');
      const inquiry = inquiries.find(i => i.id === select.value);

      if (inquiry) {
        document.getElementById('customer-name').value = inquiry.customerName;
        document.getElementById('customer-email').value = inquiry.customerEmail;
        document.getElementById('customer-phone').value = inquiry.customerPhone;
        document.getElementById('payment-method').value = inquiry.paymentPreference === 'zelle' ? 'zelle' : 'square';

        // Clear and add properties
        document.getElementById('properties-container').innerHTML = '';
        propertyCount = 0;

        (inquiry.properties || []).forEach(p => {
          addProperty(p.type, p.address, p.price);
        });

        updateTotals();
      }
    }

    // Add property row
    function addProperty(type = 'single_family', address = '', price = null) {
      propertyCount++;
      const container = document.getElementById('properties-container');
      const method = document.getElementById('payment-method').value;
      const defaultPrice = price || PRICES[method][type];

      const div = document.createElement('div');
      div.className = 'property-row';
      div.style.cssText = 'display: grid; grid-template-columns: 1fr 2fr 100px 40px; gap: 10px; margin-bottom: 10px; align-items: start;';
      div.innerHTML = `
        <select class="property-type" onchange="updatePropertyPrice(this)">
          <option value="apartment" ${type === 'apartment' ? 'selected' : ''}>Apartment</option>
          <option value="single_family" ${type === 'single_family' ? 'selected' : ''}>Single Family</option>
          <option value="multifamily" ${type === 'multifamily' ? 'selected' : ''}>Multifamily</option>
        </select>
        <input type="text" class="property-address" placeholder="Property address" value="${address}" required>
        <input type="number" class="property-price" step="0.01" value="${defaultPrice}" onchange="updateTotals()">
        <button type="button" onclick="this.parentElement.remove(); updateTotals();" style="background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; padding: 8px; cursor: pointer;"></button>
      `;

      container.appendChild(div);
      updateTotals();
    }

    // Update property price based on type
    function updatePropertyPrice(select) {
      const method = document.getElementById('payment-method').value;
      const row = select.closest('.property-row');
      const priceInput = row.querySelector('.property-price');
      priceInput.value = PRICES[method][select.value];
      updateTotals();
    }

    // Update totals
    function updateTotals() {
      const method = document.getElementById('payment-method').value;
      const priceInputs = document.querySelectorAll('.property-price');

      let subtotal = 0;
      priceInputs.forEach(input => {
        subtotal += parseFloat(input.value) || 0;
      });

      const fee = method === 'square' ? subtotal * 0.03 : 0;
      const total = subtotal + fee;

      document.getElementById('modal-subtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('modal-fee').textContent = '$' + fee.toFixed(2);
      document.getElementById('modal-total').textContent = '$' + total.toFixed(2);

      document.getElementById('fee-row').style.display = method === 'square' ? 'flex' : 'none';
    }

    // Open create invoice modal
    function openCreateInvoiceModal() {
      document.getElementById('create-invoice-modal').classList.add('show');
      document.getElementById('invoice-form').reset();
      document.getElementById('properties-container').innerHTML = '';
      propertyCount = 0;

      // Set default due date to 7 days from now
      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + 7);
      document.getElementById('due-date').value = dueDate.toISOString().split('T')[0];

      addProperty();
      updateTotals();
    }

    // Create invoice from inquiry
    function createInvoiceFromInquiry(inquiryId) {
      openCreateInvoiceModal();
      document.getElementById('inquiry-select').value = inquiryId;
      prefillFromInquiry();
    }

    // Close modal
    function closeModal() {
      document.getElementById('create-invoice-modal').classList.remove('show');
    }

    // Submit invoice
    async function submitInvoice(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submit-invoice-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      // Gather properties
      const properties = [];
      document.querySelectorAll('.property-row').forEach(row => {
        properties.push({
          type: row.querySelector('.property-type').value,
          address: row.querySelector('.property-address').value,
          price: parseFloat(row.querySelector('.property-price').value)
        });
      });

      const data = {
        inquiryId: document.getElementById('inquiry-select').value || undefined,
        customerName: document.getElementById('customer-name').value,
        customerEmail: document.getElementById('customer-email').value,
        customerPhone: document.getElementById('customer-phone').value,
        paymentMethod: document.getElementById('payment-method').value,
        dueDate: document.getElementById('due-date').value,
        properties,
        notes: document.getElementById('invoice-notes').value || undefined
      };

      try {
        const response = await fetch('/api/invoices/create', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch {
          result = { error: text || `Server error (${response.status})` };
        }

        if (response.ok) {
          alert('Invoice sent successfully!');
          closeModal();
          fetchData(); // Refresh data
        } else if (response.status === 409 && result.warning === 'duplicate_detected') {
          // Duplicate detected  ask user to confirm
          if (confirm(result.message)) {
            data.forceDuplicate = true;
            const retryResponse = await fetch('/api/invoices/create', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(data)
            });
            if (retryResponse.ok) {
              alert('Invoice sent successfully!');
              closeModal();
              fetchData();
            } else {
              const retryResult = await retryResponse.json().catch(() => ({}));
              alert('Error: ' + (retryResult.error || 'Failed to create invoice'));
            }
          }
        } else {
          alert('Error: ' + (result.error || 'Failed to create invoice') + (result.details ? '\n' + result.details : ''));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Invoice';
      }
    }

    // Mark invoice as paid
    async function markPaid(invoiceId) {
      if (!confirm('Mark this invoice as paid?')) return;

      try {
        const response = await fetch(`/api/invoices/${invoiceId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'mark_paid' })
        });

        if (response.ok) {
          fetchData();
        } else {
          alert('Failed to update invoice');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Retry sending a draft invoice
    async function retrySendInvoice(invoiceId) {
      if (!confirm('Retry sending this invoice?')) return;

      try {
        const response = await fetch(`/api/invoices/${invoiceId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'retry_send' })
        });

        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch {
          result = { error: text || `Server error (${response.status})` };
        }

        if (response.ok) {
          alert('Invoice sent successfully!');
          fetchData();
        } else {
          alert('Error: ' + (result.error || 'Failed to send invoice') + (result.details ? '\n' + result.details : ''));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Edit Invoice Modal
    function openEditInvoiceModal(invoiceId) {
      const invoice = invoices.find(i => i.id === invoiceId);
      if (!invoice) return;

      document.getElementById('edit-invoice-id').value = invoiceId;
      document.getElementById('edit-customer-name').value = invoice.customerName;
      document.getElementById('edit-customer-email').value = invoice.customerEmail;
      document.getElementById('edit-customer-phone').value = invoice.customerPhone;
      document.getElementById('edit-due-date').value = invoice.dueDate || '';
      document.getElementById('edit-invoice-notes').value = invoice.notes || '';
      document.getElementById('edit-invoice-modal').classList.add('show');
    }

    function closeEditInvoiceModal() {
      document.getElementById('edit-invoice-modal').classList.remove('show');
    }

    async function submitEditInvoice(e) {
      e.preventDefault();
      const btn = document.getElementById('edit-invoice-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      const invoiceId = document.getElementById('edit-invoice-id').value;
      const data = {
        action: 'edit',
        customerName: document.getElementById('edit-customer-name').value,
        customerEmail: document.getElementById('edit-customer-email').value,
        customerPhone: document.getElementById('edit-customer-phone').value,
        dueDate: document.getElementById('edit-due-date').value,
        notes: document.getElementById('edit-invoice-notes').value,
      };

      try {
        const response = await fetch(`/api/invoices/${invoiceId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          closeEditInvoiceModal();
          fetchData();
        } else {
          const result = await response.json();
          alert('Error: ' + (result.error || 'Failed to update invoice'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Changes';
      }
    }

    // Send payment reminder
    async function sendReminder(invoiceId) {
      if (!confirm('Send payment reminder email to customer?')) return;

      try {
        const response = await fetch(`/api/invoices/${invoiceId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'send_reminder' })
        });

        if (response.ok) {
          alert('Reminder sent!');
          fetchData();
        } else {
          const result = await response.json();
          alert('Error: ' + (result.error || 'Failed to send reminder'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Start inspection for a booking
    async function startInspection(bookingId) {
      try {
        const response = await fetch('/api/inspections/start', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ bookingId, inspectorName: 'CheckMyRental Inspector' })
        });

        const data = await response.json();
        if (response.ok && data.inspectionUrl) {
          window.open(data.inspectionUrl, '_blank');
        } else {
          alert('Failed to start inspection: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // View/generate report for a completed booking
    async function viewReport(bookingId) {
      try {
        // Check if inspection exists
        const listResponse = await fetch('/api/inspections/list', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const listData = await listResponse.json();
        const inspection = (listData.inspections || []).find(i => i.bookingId === bookingId);

        if (!inspection) {
          alert('No inspection found for this booking. Start an inspection first.');
          return;
        }

        if (inspection.status !== 'completed') {
          // Open the inspection page for the inspector to complete
          const baseUrl = window.location.origin;
          window.open(`${baseUrl}/inspect/${inspection.inspectionToken}`, '_blank');
          return;
        }

        // Generate report
        const reportResponse = await fetch('/api/inspections/generate-report', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ inspectionId: inspection.id })
        });

        const reportData = await reportResponse.json();
        if (reportResponse.ok && reportData.reportHtml) {
          // Open report in a new window
          const reportWindow = window.open('', '_blank');
          reportWindow.document.write(`
            <!DOCTYPE html><html><head><title>Inspection Report - ${inspection.propertyAddress}</title>
            <style>body { margin: 20px; } @media print { body { margin: 0; } }</style></head>
            <body>${reportData.reportHtml}
            <div style="text-align: center; margin-top: 20px;">
              <button onclick="window.print()" style="padding: 10px 24px; background: #2563eb; color: #fff; border: none; border-radius: 8px; font-size: 14px; cursor: pointer;">Print / Save as PDF</button>
            </div></body></html>
          `);
          reportWindow.document.close();

          if (reportData.emailSent) {
            alert('Report generated and emailed to landlord!');
          }
        } else {
          alert('Failed to generate report: ' + (reportData.error || 'Unknown error'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Booking Notes Modal
    function openBookingNotesModal(bookingId) {
      const booking = bookings.find(b => b.id === bookingId);
      if (!booking) return;

      document.getElementById('booking-notes-id').value = bookingId;
      document.getElementById('booking-notes-text').value = booking.notes || '';
      document.getElementById('booking-notes-info').innerHTML = `
        <strong>${booking.propertyAddress}</strong><br>
        <small style="color: #64748b;">Tenant: ${booking.tenantName} | ${booking.scheduledDate ? new Date(booking.scheduledDate + 'T12:00:00').toLocaleDateString() : 'Not scheduled'}</small>
      `;
      document.getElementById('booking-notes-modal').classList.add('show');
    }

    function closeBookingNotesModal() {
      document.getElementById('booking-notes-modal').classList.remove('show');
    }

    async function submitBookingNotes(e) {
      e.preventDefault();
      const btn = document.getElementById('save-booking-notes-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      const bookingId = document.getElementById('booking-notes-id').value;
      const notes = document.getElementById('booking-notes-text').value;

      try {
        const response = await fetch(`/api/bookings/${bookingId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'update_notes', notes })
        });

        if (response.ok) {
          closeBookingNotesModal();
          fetchData();
        } else {
          const result = await response.json();
          alert('Error: ' + (result.error || 'Failed to save notes'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Notes';
      }
    }

    // Cancel invoice
    async function cancelInvoice(invoiceId) {
      if (!confirm('Cancel this invoice? This cannot be undone.')) return;

      try {
        const response = await fetch(`/api/invoices/${invoiceId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'cancel' })
        });

        if (response.ok) {
          fetchData();
        } else {
          alert('Failed to cancel invoice');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Bulk invoice actions
    function toggleAllInvoices(checkbox) {
      document.querySelectorAll('.invoice-check:not(:disabled)').forEach(cb => {
        cb.checked = checkbox.checked;
      });
      updateBulkActions();
    }

    function updateBulkActions() {
      const checked = document.querySelectorAll('.invoice-check:checked');
      const bulkBar = document.getElementById('bulk-actions');
      const bulkBtn = document.getElementById('bulk-paid-btn');
      if (checked.length > 0) {
        bulkBar.style.display = 'block';
        bulkBtn.textContent = `Mark ${checked.length} as Paid`;
      } else {
        bulkBar.style.display = 'none';
      }
    }

    async function bulkMarkPaid() {
      const checked = Array.from(document.querySelectorAll('.invoice-check:checked'));
      if (checked.length === 0) return;
      if (!confirm(`Mark ${checked.length} invoice(s) as paid?`)) return;

      const btn = document.getElementById('bulk-paid-btn');
      btn.disabled = true;
      let completed = 0;

      for (const cb of checked) {
        btn.textContent = `Processing ${++completed}/${checked.length}...`;
        try {
          await fetch(`/api/invoices/${cb.value}`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ action: 'mark_paid' })
          });
        } catch (error) {
          console.error('Error marking paid:', error);
        }
      }

      btn.disabled = false;
      document.getElementById('select-all-invoices').checked = false;
      document.getElementById('bulk-actions').style.display = 'none';
      fetchData();
    }

    // CSV Export utilities
    function downloadCSV(filename, headers, rows) {
      const csv = [
        headers.join(','),
        ...rows.map(r => r.map(v => `"${String(v ?? '').replace(/"/g, '""')}"`).join(','))
      ].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportInquiries() {
      const headers = ['Date', 'Customer', 'Email', 'Phone', 'Properties', 'Total', 'Payment Pref.', 'Frequency', 'Status'];
      const rows = inquiries.map(i => [
        new Date(i.createdAt).toLocaleDateString(),
        i.customerName, i.customerEmail, i.customerPhone,
        i.properties?.length || 0,
        (i.total || 0).toFixed(2),
        i.paymentPreference,
        i.inspectionFrequency || '',
        i.status
      ]);
      downloadCSV('inquiries.csv', headers, rows);
    }

    function exportInvoices() {
      const headers = ['Invoice #', 'Date', 'Customer', 'Email', 'Phone', 'Amount', 'Method', 'Status', 'Due Date'];
      const rows = invoices.map(i => [
        i.invoiceNumber,
        new Date(i.createdAt).toLocaleDateString(),
        i.customerName, i.customerEmail, i.customerPhone,
        (i.total || 0).toFixed(2),
        i.paymentMethod,
        i.status,
        i.dueDate || ''
      ]);
      downloadCSV('invoices.csv', headers, rows);
    }

    function exportBookings() {
      const headers = ['Date', 'Time', 'Property', 'Zone', 'Tenant', 'Tenant Phone', 'Landlord', 'Landlord Email', 'Status', 'Frequency'];
      const rows = bookings.map(b => [
        b.scheduledDate || 'Not scheduled',
        b.scheduledTime ? formatTime(b.scheduledTime) : '',
        b.propertyAddress,
        b.serviceZone || '',
        b.tenantName, b.tenantPhone,
        b.landlordName, b.landlordEmail,
        b.status,
        b.inspectionFrequency || ''
      ]);
      downloadCSV('bookings.csv', headers, rows);
    }

    // Logout
    function logout() {
      localStorage.removeItem('adminToken');
      window.location.href = '/admin/login';
    }

    // Tab click handlers
    document.querySelectorAll('.tabs .tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const parent = this.closest('.tabs');
        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');

        const filter = this.dataset.filter;
        const date = this.dataset.date;
        const section = this.closest('.section');

        if (section.querySelector('#inquiries-table')) {
          renderInquiries(filter);
        } else if (section.querySelector('#bookings-table')) {
          renderBookings(filter);
        } else if (section.querySelector('#route-list')) {
          // Route date tabs
          renderRoute(date === 'tomorrow' ? 1 : 0);
        } else {
          renderInvoices(filter);
        }
      });
    });

    // Payment method change handler
    document.getElementById('payment-method').addEventListener('change', function() {
      // Update all property prices
      document.querySelectorAll('.property-row').forEach(row => {
        const type = row.querySelector('.property-type').value;
        row.querySelector('.property-price').value = PRICES[this.value][type];
      });
      updateTotals();
    });

    // Slot Locks
    function renderSlotLocks() {
      const badge = document.getElementById('locks-badge');
      const list = document.getElementById('locks-list');

      if (slotLocks.length === 0) {
        badge.style.display = 'none';
        document.getElementById('locks-panel').style.display = 'none';
        return;
      }

      badge.style.display = 'inline';
      badge.textContent = `${slotLocks.length} lock${slotLocks.length > 1 ? 's' : ''}`;

      list.innerHTML = slotLocks.map(lock => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: white; border-radius: 6px; margin-bottom: 6px;">
          <div>
            <strong>${lock.date}</strong> at <strong>${formatTime(lock.time)}</strong>
            <span style="color: #94a3b8; font-size: 12px; margin-left: 8px;">TTL: ${lock.ttl}s</span>
          </div>
          <button class="table-btn table-btn-secondary" onclick="releaseSlotLock('${lock.date}', '${lock.time}')" style="background: #fee2e2; color: #dc2626;">
            Release
          </button>
        </div>
      `).join('');
    }

    function toggleLocksPanel() {
      const panel = document.getElementById('locks-panel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    }

    async function releaseSlotLock(date, time) {
      if (!confirm(`Release lock for ${date} at ${time}?`)) return;

      try {
        // Use any booking id since the action just needs auth
        const anyBooking = bookings[0];
        if (!anyBooking) {
          alert('No bookings available to use as endpoint');
          return;
        }

        const response = await fetch(`/api/bookings/${anyBooking.id}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'release_lock', lockDate: date, lockTime: time })
        });

        if (response.ok) {
          fetchData();
        } else {
          alert('Failed to release lock');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Reports
    let currentReport = 'revenue';

    document.querySelectorAll('#reports-tabs .tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('#reports-tabs .tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        currentReport = this.dataset.report;
        renderReports();
      });
    });

    function renderReports() {
      const container = document.getElementById('reports-content');
      if (!invoices.length && !bookings.length) {
        container.innerHTML = '<div class="empty-state"><p>No data yet</p></div>';
        return;
      }

      switch (currentReport) {
        case 'revenue': renderRevenueReport(container); break;
        case 'methods': renderMethodsReport(container); break;
        case 'zones': renderZonesReport(container); break;
        case 'overview': renderOverviewReport(container); break;
      }
    }

    function renderRevenueReport(container) {
      const paidInvoices = invoices.filter(i => i.status === 'paid');
      const revenueByMonth = {};

      paidInvoices.forEach(inv => {
        const month = (inv.paidAt || inv.createdAt).substring(0, 7);
        revenueByMonth[month] = (revenueByMonth[month] || 0) + (inv.total || 0);
      });

      const months = Object.keys(revenueByMonth).sort().slice(-6);
      const maxRevenue = Math.max(...months.map(m => revenueByMonth[m]), 1);
      const totalRevenue = paidInvoices.reduce((sum, i) => sum + (i.total || 0), 0);

      const monthLabels = { '01': 'Jan', '02': 'Feb', '03': 'Mar', '04': 'Apr', '05': 'May', '06': 'Jun', '07': 'Jul', '08': 'Aug', '09': 'Sep', '10': 'Oct', '11': 'Nov', '12': 'Dec' };

      container.innerHTML = `
        <div class="report-grid">
          <div class="report-card">
            <div class="report-value" style="color: #10b981;">$${totalRevenue.toFixed(2)}</div>
            <div class="report-label">Total Revenue</div>
          </div>
          <div class="report-card">
            <div class="report-value">${paidInvoices.length}</div>
            <div class="report-label">Paid Invoices</div>
          </div>
          <div class="report-card">
            <div class="report-value">$${paidInvoices.length ? (totalRevenue / paidInvoices.length).toFixed(2) : '0.00'}</div>
            <div class="report-label">Avg Invoice</div>
          </div>
        </div>
        <h4 style="margin-bottom: 16px; color: #1e293b;">Monthly Revenue</h4>
        <div class="bar-chart">
          ${months.length ? months.map(m => {
            const label = monthLabels[m.split('-')[1]] + ' ' + m.split('-')[0].slice(2);
            const pct = (revenueByMonth[m] / maxRevenue * 100).toFixed(0);
            return `
              <div class="bar-row">
                <div class="bar-label">${label}</div>
                <div class="bar-track">
                  <div class="bar-fill" style="width: ${pct}%; background: linear-gradient(135deg, #10b981, #059669);">
                    ${pct > 15 ? '$' + revenueByMonth[m].toFixed(0) : ''}
                  </div>
                </div>
                <div class="bar-amount">$${revenueByMonth[m].toFixed(2)}</div>
              </div>
            `;
          }).join('') : '<p style="color: #94a3b8; text-align: center;">No revenue data yet</p>'}
        </div>
      `;
    }

    function renderMethodsReport(container) {
      const paidInvoices = invoices.filter(i => i.status === 'paid');
      const zelle = paidInvoices.filter(i => i.paymentMethod === 'zelle');
      const square = paidInvoices.filter(i => i.paymentMethod === 'square');
      const zelleTotal = zelle.reduce((s, i) => s + (i.total || 0), 0);
      const squareTotal = square.reduce((s, i) => s + (i.total || 0), 0);
      const maxCount = Math.max(zelle.length, square.length, 1);

      container.innerHTML = `
        <div class="report-grid">
          <div class="report-card">
            <div class="report-value" style="color: #7c3aed;">${zelle.length}</div>
            <div class="report-label">Zelle Invoices</div>
          </div>
          <div class="report-card">
            <div class="report-value" style="color: #7c3aed;">$${zelleTotal.toFixed(2)}</div>
            <div class="report-label">Zelle Revenue</div>
          </div>
          <div class="report-card">
            <div class="report-value" style="color: #059669;">${square.length}</div>
            <div class="report-label">Square Invoices</div>
          </div>
          <div class="report-card">
            <div class="report-value" style="color: #059669;">$${squareTotal.toFixed(2)}</div>
            <div class="report-label">Square Revenue</div>
          </div>
        </div>
        <h4 style="margin-bottom: 16px; color: #1e293b;">Invoice Count by Method</h4>
        <div class="bar-chart">
          <div class="bar-row">
            <div class="bar-label">Zelle</div>
            <div class="bar-track">
              <div class="bar-fill" style="width: ${(zelle.length / maxCount * 100).toFixed(0)}%; background: #7c3aed;">${zelle.length}</div>
            </div>
            <div class="bar-amount">$${zelleTotal.toFixed(2)}</div>
          </div>
          <div class="bar-row">
            <div class="bar-label">Square</div>
            <div class="bar-track">
              <div class="bar-fill" style="width: ${(square.length / maxCount * 100).toFixed(0)}%; background: #059669;">${square.length}</div>
            </div>
            <div class="bar-amount">$${squareTotal.toFixed(2)}</div>
          </div>
        </div>
      `;
    }

    function renderZonesReport(container) {
      const zoneData = {};
      bookings.forEach(b => {
        const zone = b.serviceZone || 'UNKNOWN';
        if (!zoneData[zone]) zoneData[zone] = { total: 0, completed: 0, noShow: 0 };
        zoneData[zone].total++;
        if (b.status === 'completed') zoneData[zone].completed++;
        if (b.status === 'no_show') zoneData[zone].noShow++;
      });

      const zones = Object.keys(zoneData).sort((a, b) => zoneData[b].total - zoneData[a].total);
      const maxTotal = Math.max(...zones.map(z => zoneData[z].total), 1);
      const zoneColors = { TAMPA: '#f59e0b', NORTH: '#3b82f6', CENTRAL: '#22c55e', SOUTH: '#ec4899', EAST: '#8b5cf6', UNKNOWN: '#94a3b8' };

      const totalBookings = bookings.length;
      const completedBookings = bookings.filter(b => b.status === 'completed').length;
      const noShows = bookings.filter(b => b.status === 'no_show').length;
      const noShowRate = (completedBookings + noShows) > 0 ? (noShows / (completedBookings + noShows) * 100).toFixed(1) : '0';

      container.innerHTML = `
        <div class="report-grid">
          <div class="report-card">
            <div class="report-value">${totalBookings}</div>
            <div class="report-label">Total Bookings</div>
          </div>
          <div class="report-card">
            <div class="report-value" style="color: #10b981;">${completedBookings}</div>
            <div class="report-label">Completed</div>
          </div>
          <div class="report-card">
            <div class="report-value" style="color: #dc2626;">${noShows}</div>
            <div class="report-label">No Shows</div>
          </div>
          <div class="report-card">
            <div class="report-value" style="color: ${parseFloat(noShowRate) > 10 ? '#dc2626' : '#10b981'};">${noShowRate}%</div>
            <div class="report-label">No Show Rate</div>
          </div>
        </div>
        <h4 style="margin-bottom: 16px; color: #1e293b;">Bookings by Zone</h4>
        <div class="bar-chart">
          ${zones.map(zone => `
            <div class="bar-row">
              <div class="bar-label">${zone}</div>
              <div class="bar-track">
                <div class="bar-fill" style="width: ${(zoneData[zone].total / maxTotal * 100).toFixed(0)}%; background: ${zoneColors[zone] || '#94a3b8'};">${zoneData[zone].total}</div>
              </div>
              <div class="bar-amount">${zoneData[zone].completed} done</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderOverviewReport(container) {
      const totalInquiries = inquiries.length;
      const totalInvoices = invoices.length;
      const paidInvoices = invoices.filter(i => i.status === 'paid').length;
      const conversionRate = totalInvoices > 0 ? (paidInvoices / totalInvoices * 100).toFixed(1) : '0';

      const completedBookings = bookings.filter(b => b.status === 'completed').length;
      const scheduledBookings = bookings.filter(b => b.status === 'scheduled').length;
      const pendingBookings = bookings.filter(b => b.status === 'pending_tenant').length;
      const cancelledBookings = bookings.filter(b => b.status === 'cancelled').length;

      const recurringBookings = bookings.filter(b => b.inspectionFrequency && b.inspectionFrequency !== 'one_time').length;
      const recurringPct = bookings.length > 0 ? (recurringBookings / bookings.length * 100).toFixed(0) : '0';

      container.innerHTML = `
        <div class="report-grid">
          <div class="report-card">
            <div class="report-value">${totalInquiries}</div>
            <div class="report-label">Total Inquiries</div>
          </div>
          <div class="report-card">
            <div class="report-value">${totalInvoices}</div>
            <div class="report-label">Total Invoices</div>
          </div>
          <div class="report-card">
            <div class="report-value" style="color: ${parseFloat(conversionRate) > 50 ? '#10b981' : '#f59e0b'};">${conversionRate}%</div>
            <div class="report-label">Conversion Rate</div>
          </div>
          <div class="report-card">
            <div class="report-value" style="color: #8b5cf6;">${recurringPct}%</div>
            <div class="report-label">Recurring</div>
          </div>
        </div>
        <h4 style="margin-bottom: 16px; color: #1e293b;">Booking Status Breakdown</h4>
        <div class="bar-chart">
          ${[
            { label: 'Completed', count: completedBookings, color: '#10b981' },
            { label: 'Scheduled', count: scheduledBookings, color: '#3b82f6' },
            { label: 'Pending', count: pendingBookings, color: '#f59e0b' },
            { label: 'Cancelled', count: cancelledBookings, color: '#94a3b8' },
          ].map(item => `
            <div class="bar-row">
              <div class="bar-label">${item.label}</div>
              <div class="bar-track">
                <div class="bar-fill" style="width: ${bookings.length ? (item.count / bookings.length * 100).toFixed(0) : 0}%; background: ${item.color};">${item.count}</div>
              </div>
              <div class="bar-amount">${bookings.length ? (item.count / bookings.length * 100).toFixed(0) : 0}%</div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Initial fetch
    fetchData();
  </script>
</body>
</html>
