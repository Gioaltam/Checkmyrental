---
// Admin Dashboard
export const prerender = false;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - CheckMyRental</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      color: white;
      font-size: 24px;
    }

    .header h1 span:first-child {
      color: white;
    }

    .header h1 span:last-child {
      color: #e74c3c;
    }

    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Main Content */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .stat-card .label {
      color: #64748b;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #1e293b;
    }

    .stat-card .value.money {
      color: #10b981;
    }

    .stat-card .value.pending {
      color: #f59e0b;
    }

    /* Sections */
    .section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }

    .section-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-header h2 {
      font-size: 18px;
      color: #1e293b;
    }

    .section-content {
      padding: 24px;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    th {
      background: #f8fafc;
      color: #64748b;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    td {
      color: #1e293b;
      font-size: 14px;
    }

    tr:hover {
      background: #f8fafc;
    }

    /* Status Badges */
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-draft {
      background: #f1f5f9;
      color: #64748b;
    }

    .badge-new {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .badge-invoiced {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-sent {
      background: #e0e7ff;
      color: #4338ca;
    }

    .badge-paid {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-overdue {
      background: #fee2e2;
      color: #dc2626;
    }

    .badge-zelle {
      background: #f3e8ff;
      color: #7c3aed;
    }

    .badge-square {
      background: #ecfdf5;
      color: #059669;
    }

    .badge-pending_tenant {
      background: #fef3c7;
      color: #92400e;
    }

    .badge-scheduled {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .badge-completed {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-cancelled {
      background: #f1f5f9;
      color: #64748b;
    }

    .badge-no_show {
      background: #fee2e2;
      color: #dc2626;
    }

    /* Action buttons in table */
    .table-actions {
      display: flex;
      gap: 8px;
    }

    .table-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .table-btn-primary {
      background: #e74c3c;
      color: white;
    }

    .table-btn-primary:hover {
      background: #c0392b;
    }

    .table-btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .table-btn-secondary:hover {
      background: #d1d5db;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 16px;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
    }

    .tab {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #64748b;
      transition: all 0.2s;
    }

    .tab.active {
      background: #e74c3c;
      color: white;
    }

    .tab:hover:not(.active) {
      background: #f1f5f9;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform 0.3s;
    }

    .modal-overlay.show .modal {
      transform: scale(1);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 18px;
      color: #1e293b;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #64748b;
      padding: 4px;
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #374151;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      background-color: #fff;
      color: #1e293b;
    }

    .form-group select option,
    .property-type option {
      background-color: #fff;
      color: #1e293b;
    }

    .property-type {
      background-color: #fff;
      color: #1e293b;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #e74c3c;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        padding: 15px;
      }

      .main {
        padding: 15px;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 13px;
      }

      th, td {
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <h1><span>CheckMy</span><span>Rental</span> <span style="font-weight: 400; font-size: 16px; margin-left: 10px;">Admin</span></h1>
    <div class="header-actions">
      <a href="/admin/availability" class="btn btn-secondary">Availability</a>
      <button class="btn btn-primary" onclick="openCreateInvoiceModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Create Invoice
      </button>
      <button class="btn btn-secondary" onclick="logout()">Logout</button>
    </div>
  </header>

  <main class="main">
    <!-- Stats -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="label">New Inquiries</div>
        <div class="value" id="stat-new-inquiries">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Invoices</div>
        <div class="value" id="stat-total-invoices">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Paid Invoices</div>
        <div class="value money" id="stat-paid-invoices">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Pending Amount</div>
        <div class="value pending" id="stat-pending-amount">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Pending Bookings</div>
        <div class="value" id="stat-pending-bookings">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Scheduled This Week</div>
        <div class="value" id="stat-scheduled-week">-</div>
      </div>
    </div>

    <!-- Inquiries Section -->
    <section class="section">
      <div class="section-header">
        <h2>Recent Inquiries</h2>
        <div class="tabs">
          <button class="tab active" data-filter="new">New</button>
          <button class="tab" data-filter="all">All</button>
        </div>
      </div>
      <div class="section-content">
        <div class="table-container">
          <table id="inquiries-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Customer</th>
                <th>Properties</th>
                <th>Total</th>
                <th>Payment Pref.</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="inquiries-tbody">
              <tr><td colspan="7" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Invoices Section -->
    <section class="section">
      <div class="section-header">
        <h2>Invoices</h2>
        <div class="tabs">
          <button class="tab active" data-filter="pending">Pending</button>
          <button class="tab" data-filter="paid">Paid</button>
          <button class="tab" data-filter="all">All</button>
        </div>
      </div>
      <div class="section-content">
        <div class="table-container">
          <table id="invoices-table">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Date</th>
                <th>Customer</th>
                <th>Amount</th>
                <th>Method</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="invoices-tbody">
              <tr><td colspan="7" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Bookings Section -->
    <section class="section">
      <div class="section-header">
        <h2>Tenant Bookings</h2>
        <div class="tabs" id="bookings-tabs">
          <button class="tab active" data-filter="pending_tenant">Pending</button>
          <button class="tab" data-filter="scheduled">Scheduled</button>
          <button class="tab" data-filter="all">All</button>
        </div>
      </div>
      <div class="section-content">
        <div class="table-container">
          <table id="bookings-table">
            <thead>
              <tr>
                <th>Date/Time</th>
                <th>Property</th>
                <th>Tenant</th>
                <th>Landlord</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="bookings-tbody">
              <tr><td colspan="6" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Create Invoice Modal -->
  <div class="modal-overlay" id="create-invoice-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>Create Invoice</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <form id="invoice-form" onsubmit="submitInvoice(event)">
        <div class="modal-body">
          <!-- Pre-fill from inquiry selector -->
          <div class="form-group">
            <label>From Inquiry (optional)</label>
            <select id="inquiry-select" onchange="prefillFromInquiry()">
              <option value="">-- Enter details manually --</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Customer Name *</label>
              <input type="text" id="customer-name" required>
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="customer-email" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Phone *</label>
              <input type="tel" id="customer-phone" required>
            </div>
            <div class="form-group">
              <label>Payment Method *</label>
              <select id="payment-method" required>
                <option value="zelle">Zelle (No fee)</option>
                <option value="square">Credit/Debit Card (+3% fee)</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Due Date *</label>
            <input type="date" id="due-date" required>
          </div>

          <!-- Properties -->
          <div class="form-group">
            <label>Properties</label>
            <div id="properties-container">
              <!-- Properties will be added here -->
            </div>
            <button type="button" class="table-btn table-btn-secondary" onclick="addProperty()" style="margin-top: 10px;">
              + Add Property
            </button>
          </div>

          <div class="form-group">
            <label>Notes (optional)</label>
            <textarea id="invoice-notes" rows="3" placeholder="Any additional notes..."></textarea>
          </div>

          <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Subtotal:</span>
              <span id="modal-subtotal">$0.00</span>
            </div>
            <div style="display: none; justify-content: space-between; margin-bottom: 8px;" id="fee-row">
              <span>Processing Fee (3%):</span>
              <span id="modal-fee">$0.00</span>
            </div>
            <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 18px; color: #e74c3c;">
              <span>Total:</span>
              <span id="modal-total">$0.00</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submit-invoice-btn">Send Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <script is:inline>
    // Auth check
    const token = localStorage.getItem('adminToken');
    if (!token) {
      window.location.href = '/admin/login';
    }

    // Prices
    const PRICES = {
      zelle: { apartment: 70, single_family: 100, multifamily: 165 },
      card: { apartment: 72.33, single_family: 103.20, multifamily: 170.09 }
    };

    // State
    let inquiries = [];
    let invoices = [];
    let bookings = [];
    let propertyCount = 0;

    // Fetch data
    async function fetchData() {
      try {
        // Fetch invoices and inquiries
        const response = await fetch('/api/invoices/list?type=all', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.status === 401) {
          localStorage.removeItem('adminToken');
          window.location.href = '/admin/login';
          return;
        }

        const data = await response.json();

        if (data.stats) {
          document.getElementById('stat-new-inquiries').textContent = data.stats.newInquiries || 0;
          document.getElementById('stat-total-invoices').textContent = data.stats.totalInvoices || 0;
          document.getElementById('stat-paid-invoices').textContent = data.stats.paidInvoices || 0;
          document.getElementById('stat-pending-amount').textContent = '$' + (data.stats.pendingAmount || 0).toFixed(2);
        }

        inquiries = data.inquiries || [];
        invoices = data.invoices || [];

        renderInquiries();
        renderInvoices();
        populateInquirySelect();

        // Fetch bookings
        const bookingsResponse = await fetch('/api/bookings/list', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (bookingsResponse.ok) {
          const bookingsData = await bookingsResponse.json();
          bookings = bookingsData.bookings || [];

          if (bookingsData.stats) {
            document.getElementById('stat-pending-bookings').textContent = bookingsData.stats.pendingBookings || 0;
            document.getElementById('stat-scheduled-week').textContent = bookingsData.stats.scheduledThisWeek || 0;
          }

          renderBookings();
        }
      } catch (error) {
        console.error('Fetch error:', error);
      }
    }

    // Render inquiries table
    function renderInquiries(filter = 'new') {
      const tbody = document.getElementById('inquiries-tbody');
      let filtered = inquiries;

      if (filter === 'new') {
        filtered = inquiries.filter(i => i.status === 'new');
      }

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <p>No ${filter === 'new' ? 'new ' : ''}inquiries found</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filtered.map(inquiry => `
        <tr>
          <td>${new Date(inquiry.createdAt).toLocaleDateString()}</td>
          <td>
            <strong>${inquiry.customerName}</strong><br>
            <small style="color: #64748b;">${inquiry.customerEmail}</small>
          </td>
          <td>${inquiry.properties?.length || 0} properties</td>
          <td>$${(inquiry.total || 0).toFixed(2)}</td>
          <td><span class="badge badge-${inquiry.paymentPreference}">${inquiry.paymentPreference === 'zelle' ? 'Zelle' : 'Card'}</span></td>
          <td><span class="badge badge-${inquiry.status}">${inquiry.status}</span></td>
          <td>
            <div class="table-actions">
              ${inquiry.status === 'new' ? `
                <button class="table-btn table-btn-primary" onclick="createInvoiceFromInquiry('${inquiry.id}')">
                  Create Invoice
                </button>
              ` : ''}
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Render invoices table
    function renderInvoices(filter = 'pending') {
      const tbody = document.getElementById('invoices-tbody');
      let filtered = invoices;

      if (filter === 'pending') {
        filtered = invoices.filter(i => ['draft', 'sent', 'viewed', 'overdue'].includes(i.status));
      } else if (filter === 'paid') {
        filtered = invoices.filter(i => i.status === 'paid');
      }

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <p>No ${filter !== 'all' ? filter + ' ' : ''}invoices found</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filtered.map(invoice => `
        <tr>
          <td><strong>${invoice.invoiceNumber}</strong></td>
          <td>${new Date(invoice.createdAt).toLocaleDateString()}</td>
          <td>
            <strong>${invoice.customerName}</strong><br>
            <small style="color: #64748b;">${invoice.customerEmail}</small>
          </td>
          <td>$${(invoice.total || 0).toFixed(2)}</td>
          <td><span class="badge badge-${invoice.paymentMethod}">${invoice.paymentMethod === 'zelle' ? 'Zelle' : 'Square'}</span></td>
          <td><span class="badge badge-${invoice.status}">${invoice.status}</span></td>
          <td>
            <div class="table-actions">
              ${invoice.status === 'draft' ? `
                <button class="table-btn table-btn-primary" onclick="retrySendInvoice('${invoice.id}')">
                  Retry Send
                </button>
              ` : ''}
              ${invoice.status !== 'paid' && invoice.status !== 'cancelled' ? `
                <button class="table-btn table-btn-primary" onclick="markPaid('${invoice.id}')">
                  Mark Paid
                </button>
              ` : ''}
              ${invoice.status === 'paid' ? `
                <button class="table-btn table-btn-secondary" onclick="sendBookingLinks('${invoice.id}')">
                  Send Booking Links
                </button>
              ` : ''}
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Render bookings table
    function renderBookings(filter = 'pending_tenant') {
      const tbody = document.getElementById('bookings-tbody');
      let filtered = bookings;

      if (filter === 'pending_tenant') {
        filtered = bookings.filter(b => b.status === 'pending_tenant');
      } else if (filter === 'scheduled') {
        filtered = bookings.filter(b => b.status === 'scheduled');
      }

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="empty-state">
              <p>No ${filter === 'pending_tenant' ? 'pending ' : filter === 'scheduled' ? 'scheduled ' : ''}bookings found</p>
            </td>
          </tr>
        `;
        return;
      }

      const STATUS_LABELS = {
        pending_tenant: 'Awaiting Tenant',
        scheduled: 'Scheduled',
        completed: 'Completed',
        cancelled: 'Cancelled',
        no_show: 'No Show'
      };

      tbody.innerHTML = filtered.map(booking => {
        const dateTime = booking.scheduledDate && booking.scheduledTime
          ? `${new Date(booking.scheduledDate + 'T12:00:00').toLocaleDateString()}<br><small>${formatTime(booking.scheduledTime)}</small>`
          : '<span style="color: #94a3b8;">Not scheduled</span>';

        return `
          <tr>
            <td>${dateTime}</td>
            <td>${booking.propertyAddress}</td>
            <td>
              <strong>${booking.tenantName}</strong><br>
              <small style="color: #64748b;">${booking.tenantPhone}</small>
            </td>
            <td>
              <strong>${booking.landlordName}</strong><br>
              <small style="color: #64748b;">${booking.landlordEmail}</small>
            </td>
            <td><span class="badge badge-${booking.status}">${STATUS_LABELS[booking.status] || booking.status}</span></td>
            <td>
              <div class="table-actions">
                ${booking.status === 'pending_tenant' ? `
                  <button class="table-btn table-btn-secondary" onclick="resendBookingLink('${booking.id}')">
                    Resend Link
                  </button>
                ` : ''}
                ${booking.status === 'scheduled' ? `
                  <button class="table-btn table-btn-primary" onclick="completeBooking('${booking.id}')">
                    Complete
                  </button>
                  <button class="table-btn table-btn-secondary" onclick="cancelBooking('${booking.id}')">
                    Cancel
                  </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Format time for display
    function formatTime(timeStr) {
      const [hour, minute] = timeStr.split(':').map(Number);
      const period = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour % 12 || 12;
      return `${displayHour}:${String(minute).padStart(2, '0')} ${period}`;
    }

    // Send booking links for an invoice
    async function sendBookingLinks(invoiceId) {
      if (!confirm('Send booking links to tenants for this invoice?')) return;

      try {
        const response = await fetch('/api/bookings/send-links', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ invoiceId })
        });

        const data = await response.json();

        if (response.ok) {
          alert(data.message || 'Booking links sent!');
          fetchData();
        } else {
          alert('Error: ' + (data.error || 'Failed to send booking links'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Resend booking link
    async function resendBookingLink(bookingId) {
      if (!confirm('Resend booking link to tenant?')) return;

      try {
        const response = await fetch(`/api/bookings/${bookingId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'resend_link' })
        });

        if (response.ok) {
          alert('Booking link sent!');
          fetchData();
        } else {
          const data = await response.json();
          alert('Error: ' + (data.error || 'Failed to resend'));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Complete booking
    async function completeBooking(bookingId) {
      if (!confirm('Mark this booking as completed?')) return;

      try {
        const response = await fetch(`/api/bookings/${bookingId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'complete' })
        });

        if (response.ok) {
          fetchData();
        } else {
          alert('Failed to update booking');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Cancel booking
    async function cancelBooking(bookingId) {
      if (!confirm('Cancel this booking?')) return;

      try {
        const response = await fetch(`/api/bookings/${bookingId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'cancel' })
        });

        if (response.ok) {
          fetchData();
        } else {
          alert('Failed to cancel booking');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Populate inquiry select in modal
    function populateInquirySelect() {
      const select = document.getElementById('inquiry-select');
      const newInquiries = inquiries.filter(i => i.status === 'new');

      select.innerHTML = '<option value="">-- Enter details manually --</option>' +
        newInquiries.map(i => `
          <option value="${i.id}">${i.customerName} - ${i.properties?.length || 0} properties ($${(i.total || 0).toFixed(2)})</option>
        `).join('');
    }

    // Pre-fill form from inquiry
    function prefillFromInquiry() {
      const select = document.getElementById('inquiry-select');
      const inquiry = inquiries.find(i => i.id === select.value);

      if (inquiry) {
        document.getElementById('customer-name').value = inquiry.customerName;
        document.getElementById('customer-email').value = inquiry.customerEmail;
        document.getElementById('customer-phone').value = inquiry.customerPhone;
        document.getElementById('payment-method').value = inquiry.paymentPreference === 'zelle' ? 'zelle' : 'square';

        // Clear and add properties
        document.getElementById('properties-container').innerHTML = '';
        propertyCount = 0;

        (inquiry.properties || []).forEach(p => {
          addProperty(p.type, p.address, p.price);
        });

        updateTotals();
      }
    }

    // Add property row
    function addProperty(type = 'single_family', address = '', price = null) {
      propertyCount++;
      const container = document.getElementById('properties-container');
      const method = document.getElementById('payment-method').value;
      const defaultPrice = price || PRICES[method][type];

      const div = document.createElement('div');
      div.className = 'property-row';
      div.style.cssText = 'display: grid; grid-template-columns: 1fr 2fr 100px 40px; gap: 10px; margin-bottom: 10px; align-items: start;';
      div.innerHTML = `
        <select class="property-type" onchange="updatePropertyPrice(this)">
          <option value="apartment" ${type === 'apartment' ? 'selected' : ''}>Apartment</option>
          <option value="single_family" ${type === 'single_family' ? 'selected' : ''}>Single Family</option>
          <option value="multifamily" ${type === 'multifamily' ? 'selected' : ''}>Multifamily</option>
        </select>
        <input type="text" class="property-address" placeholder="Property address" value="${address}" required>
        <input type="number" class="property-price" step="0.01" value="${defaultPrice}" onchange="updateTotals()">
        <button type="button" onclick="this.parentElement.remove(); updateTotals();" style="background: #fee2e2; color: #dc2626; border: none; border-radius: 6px; padding: 8px; cursor: pointer;">Ã—</button>
      `;

      container.appendChild(div);
      updateTotals();
    }

    // Update property price based on type
    function updatePropertyPrice(select) {
      const method = document.getElementById('payment-method').value;
      const row = select.closest('.property-row');
      const priceInput = row.querySelector('.property-price');
      priceInput.value = PRICES[method][select.value];
      updateTotals();
    }

    // Update totals
    function updateTotals() {
      const method = document.getElementById('payment-method').value;
      const priceInputs = document.querySelectorAll('.property-price');

      let subtotal = 0;
      priceInputs.forEach(input => {
        subtotal += parseFloat(input.value) || 0;
      });

      const fee = method === 'square' ? subtotal * 0.03 : 0;
      const total = subtotal + fee;

      document.getElementById('modal-subtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('modal-fee').textContent = '$' + fee.toFixed(2);
      document.getElementById('modal-total').textContent = '$' + total.toFixed(2);

      document.getElementById('fee-row').style.display = method === 'square' ? 'flex' : 'none';
    }

    // Open create invoice modal
    function openCreateInvoiceModal() {
      document.getElementById('create-invoice-modal').classList.add('show');
      document.getElementById('invoice-form').reset();
      document.getElementById('properties-container').innerHTML = '';
      propertyCount = 0;

      // Set default due date to 7 days from now
      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + 7);
      document.getElementById('due-date').value = dueDate.toISOString().split('T')[0];

      addProperty();
      updateTotals();
    }

    // Create invoice from inquiry
    function createInvoiceFromInquiry(inquiryId) {
      openCreateInvoiceModal();
      document.getElementById('inquiry-select').value = inquiryId;
      prefillFromInquiry();
    }

    // Close modal
    function closeModal() {
      document.getElementById('create-invoice-modal').classList.remove('show');
    }

    // Submit invoice
    async function submitInvoice(e) {
      e.preventDefault();

      const submitBtn = document.getElementById('submit-invoice-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      // Gather properties
      const properties = [];
      document.querySelectorAll('.property-row').forEach(row => {
        properties.push({
          type: row.querySelector('.property-type').value,
          address: row.querySelector('.property-address').value,
          price: parseFloat(row.querySelector('.property-price').value)
        });
      });

      const data = {
        inquiryId: document.getElementById('inquiry-select').value || undefined,
        customerName: document.getElementById('customer-name').value,
        customerEmail: document.getElementById('customer-email').value,
        customerPhone: document.getElementById('customer-phone').value,
        paymentMethod: document.getElementById('payment-method').value,
        dueDate: document.getElementById('due-date').value,
        properties,
        notes: document.getElementById('invoice-notes').value || undefined
      };

      try {
        const response = await fetch('/api/invoices/create', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch {
          result = { error: text || `Server error (${response.status})` };
        }

        if (response.ok) {
          alert('Invoice sent successfully!');
          closeModal();
          fetchData(); // Refresh data
        } else {
          alert('Error: ' + (result.error || 'Failed to create invoice') + (result.details ? '\n' + result.details : ''));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Invoice';
      }
    }

    // Mark invoice as paid
    async function markPaid(invoiceId) {
      if (!confirm('Mark this invoice as paid?')) return;

      try {
        const response = await fetch(`/api/invoices/${invoiceId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'mark_paid' })
        });

        if (response.ok) {
          fetchData();
        } else {
          alert('Failed to update invoice');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Retry sending a draft invoice
    async function retrySendInvoice(invoiceId) {
      if (!confirm('Retry sending this invoice?')) return;

      try {
        const response = await fetch(`/api/invoices/${invoiceId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action: 'retry_send' })
        });

        const text = await response.text();
        let result;
        try {
          result = JSON.parse(text);
        } catch {
          result = { error: text || `Server error (${response.status})` };
        }

        if (response.ok) {
          alert('Invoice sent successfully!');
          fetchData();
        } else {
          alert('Error: ' + (result.error || 'Failed to send invoice') + (result.details ? '\n' + result.details : ''));
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    // Logout
    function logout() {
      localStorage.removeItem('adminToken');
      window.location.href = '/admin/login';
    }

    // Tab click handlers
    document.querySelectorAll('.tabs .tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const parent = this.closest('.tabs');
        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');

        const filter = this.dataset.filter;
        const section = this.closest('.section');

        if (section.querySelector('#inquiries-table')) {
          renderInquiries(filter);
        } else if (section.querySelector('#bookings-table')) {
          renderBookings(filter);
        } else {
          renderInvoices(filter);
        }
      });
    });

    // Payment method change handler
    document.getElementById('payment-method').addEventListener('change', function() {
      // Update all property prices
      document.querySelectorAll('.property-row').forEach(row => {
        const type = row.querySelector('.property-type').value;
        row.querySelector('.property-price').value = PRICES[this.value][type];
      });
      updateTotals();
    });

    // Initial fetch
    fetchData();
  </script>
</body>
</html>
