---
import LandingLayout from '../layouts/LandingLayout.astro';
import Header from '../components/Header.astro';
import LandingFooter from '../components/LandingFooter.astro';
---

<LandingLayout
  title="Checkout | CheckMyRental"
  description="Complete your purchase for professional property inspection services"
>
  <Header />

  <main id="main-content" class="checkout-main" tabindex="-1">
    <div class="checkout-container">
      <div class="checkout-content">
        <!-- Order Summary -->
        <div class="order-summary-section">
          <h1>Order Summary</h1>
          <div id="checkout-items" class="checkout-items">
            <!-- Cart items will be inserted here by JavaScript -->
          </div>

          <div class="empty-cart-message" id="empty-cart-message">
            <div class="empty-icon">ðŸ›’</div>
            <p>Your cart is empty</p>
            <a href="/pricing" class="btn-back-to-pricing">View Pricing</a>
          </div>

          <div class="order-totals" id="order-totals">
            <div class="total-row subtotal">
              <span>Subtotal</span>
              <span id="checkout-subtotal">$0.00</span>
            </div>
            <div class="total-row tax">
              <span>Tax (estimated)</span>
              <span id="checkout-tax">$0.00</span>
            </div>
            <div class="total-row total">
              <span>Total</span>
              <span id="checkout-total">$0.00</span>
            </div>
          </div>
        </div>

        <!-- Checkout Form -->
        <div class="checkout-form-section">
          <h2>Contact Information</h2>
          <form id="checkout-form" class="checkout-form">
            <div class="form-group">
              <label for="full-name">Full Name <span class="required">*</span></label>
              <input type="text" id="full-name" name="full_name" required />
            </div>

            <div class="form-group">
              <label for="email">Email <span class="required">*</span></label>
              <input type="email" id="email" name="email" required />
            </div>

            <div class="form-group">
              <label for="phone">Phone Number <span class="required">*</span></label>
              <input type="tel" id="phone" name="phone" required />
            </div>

            <h2>Property Information</h2>

            <div class="form-group">
              <label for="property-address">Property Address <span class="required">*</span></label>
              <input type="text" id="property-address" name="property_address" required />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="city">City <span class="required">*</span></label>
                <input type="text" id="city" name="city" required />
              </div>

              <div class="form-group">
                <label for="state">State <span class="required">*</span></label>
                <input type="text" id="state" name="state" placeholder="FL" required />
              </div>

              <div class="form-group">
                <label for="zip">ZIP Code <span class="required">*</span></label>
                <input type="text" id="zip" name="zip" required />
              </div>
            </div>

            <div class="form-group">
              <label for="access-instructions">Property Access Instructions</label>
              <textarea id="access-instructions" name="access_instructions" rows="4" placeholder="Gate codes, key location, tenant contact info, etc."></textarea>
            </div>

            <h2>Scheduling Preference</h2>

            <div class="form-group">
              <label for="preferred-date">Preferred Documentation Visit Date <span class="required">*</span></label>
              <input type="date" id="preferred-date" name="preferred_date" required />
              <small class="form-hint">We'll confirm availability within 24 hours</small>
            </div>

            <div class="form-group">
              <label for="notes">Additional Notes</label>
              <textarea id="notes" name="notes" rows="3" placeholder="Any special requests or concerns?"></textarea>
            </div>

            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="terms" name="terms" required />
                <span>I agree to the <a href="/terms" target="_blank">Terms of Service</a> and <a href="/privacy" target="_blank">Privacy Policy</a></span>
              </label>
            </div>

            <div class="form-actions">
              <a href="/pricing" class="btn btn-secondary">Back to Pricing</a>
              <button type="submit" class="btn btn-primary">
                <span class="btn-icon">ðŸ”’</span>
                Complete Order
              </button>
            </div>

            <div id="form-error" class="form-error"></div>
            <div id="form-success" class="form-success"></div>
          </form>

          <div class="payment-info">
            <p class="payment-note">
              <strong>Payment:</strong> We'll send you a secure payment link after confirming your documentation visit appointment.
            </p>
            <p class="payment-note">
              <strong>Questions?</strong> Contact us at <a href="mailto:info@checkmyrental.io">info@checkmyrental.io</a> or <a href="tel:8132520524">(813) 252-0524</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <LandingFooter />
</LandingLayout>

<style>
  .checkout-main {
    padding-top: 100px;
    min-height: 100vh;
    background: linear-gradient(135deg, rgba(10, 10, 15, 0.98) 0%, rgba(20, 20, 30, 0.98) 100%);
  }

  body.light-mode .checkout-main {
    background: linear-gradient(135deg, #f8f9fc 0%, #ffffff 100%);
  }

  .checkout-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 3rem;
  }

  .checkout-content {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 3rem;
    align-items: start;
  }

  /* Order Summary Section */
  .order-summary-section {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 2.5rem;
    position: sticky;
    top: 100px;
  }

  body.light-mode .order-summary-section {
    background: white;
    border-color: rgba(0, 0, 0, 0.1);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .order-summary-section h1 {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 2rem;
    color: white;
  }

  body.light-mode .order-summary-section h1 {
    color: #1a1a1a;
  }

  .checkout-items {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .checkout-item {
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
  }

  body.light-mode .checkout-item {
    background: rgba(0, 0, 0, 0.02);
    border-color: rgba(0, 0, 0, 0.08);
  }

  .checkout-item-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.75rem;
  }

  .checkout-item-title {
    font-weight: 700;
    color: white;
    font-size: 1.1rem;
  }

  body.light-mode .checkout-item-title {
    color: #1a1a1a;
  }

  .checkout-item-price {
    font-weight: 700;
    color: #e74c3c;
    font-size: 1.25rem;
  }

  .checkout-item-description {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  body.light-mode .checkout-item-description {
    color: rgba(0, 0, 0, 0.6);
  }

  .checkout-item-quantity {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.85rem;
  }

  body.light-mode .checkout-item-quantity {
    color: rgba(0, 0, 0, 0.5);
  }

  .empty-cart-message {
    text-align: center;
    padding: 3rem 2rem;
    display: none;
  }

  .empty-cart-message.show {
    display: block;
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.3;
  }

  .empty-cart-message p {
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 1.5rem;
  }

  body.light-mode .empty-cart-message p {
    color: rgba(0, 0, 0, 0.5);
  }

  .btn-back-to-pricing {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    text-decoration: none;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s;
  }

  .btn-back-to-pricing:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
  }

  .order-totals {
    border-top: 2px solid rgba(255, 255, 255, 0.1);
    padding-top: 1.5rem;
    display: none;
  }

  .order-totals.show {
    display: block;
  }

  body.light-mode .order-totals {
    border-top-color: rgba(0, 0, 0, 0.1);
  }

  .total-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.8);
  }

  body.light-mode .total-row {
    color: rgba(0, 0, 0, 0.7);
  }

  .total-row.total {
    font-size: 1.5rem;
    font-weight: 700;
    color: white;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  body.light-mode .total-row.total {
    color: #1a1a1a;
    border-top-color: rgba(0, 0, 0, 0.1);
  }

  /* Checkout Form Section */
  .checkout-form-section {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 2.5rem;
  }

  body.light-mode .checkout-form-section {
    background: white;
    border-color: rgba(0, 0, 0, 0.1);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .checkout-form-section h2 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 2rem 0 1.5rem 0;
    color: white;
  }

  .checkout-form-section h2:first-child {
    margin-top: 0;
  }

  body.light-mode .checkout-form-section h2 {
    color: #1a1a1a;
  }

  .checkout-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 1rem;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group label {
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.95rem;
  }

  body.light-mode .form-group label {
    color: #333;
  }

  .required {
    color: #e74c3c;
  }

  .form-group input,
  .form-group textarea {
    padding: 0.875rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    color: white;
    font-size: 1rem;
    transition: all 0.3s;
    font-family: inherit;
  }

  body.light-mode .form-group input,
  body.light-mode .form-group textarea {
    background: rgba(0, 0, 0, 0.03);
    border-color: rgba(0, 0, 0, 0.15);
    color: #1a1a1a;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #e74c3c;
    background: rgba(255, 255, 255, 0.08);
    box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
  }

  body.light-mode .form-group input:focus,
  body.light-mode .form-group textarea:focus {
    background: white;
    border-color: #e74c3c;
  }

  .form-hint {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.85rem;
  }

  body.light-mode .form-hint {
    color: rgba(0, 0, 0, 0.5);
  }

  .checkbox-group {
    margin-top: 1rem;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    color: rgba(255, 255, 255, 0.8);
  }

  body.light-mode .checkbox-label {
    color: rgba(0, 0, 0, 0.7);
  }

  .checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .checkbox-label a {
    color: #e74c3c;
    text-decoration: underline;
  }

  .checkbox-label a:hover {
    color: #ff6b6b;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
  }

  .btn {
    padding: 1rem 2rem;
    font-size: 1rem;
    font-weight: 600;
    border-radius: 12px;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    flex: 1;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
  }

  .btn-secondary {
    background: rgba(100, 116, 139, 0.15);
    color: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(100, 116, 139, 0.3);
  }

  .btn-secondary:hover {
    background: rgba(100, 116, 139, 0.25);
  }

  body.light-mode .btn-secondary {
    background: rgba(0, 0, 0, 0.05);
    color: #1a1a1a;
    border-color: rgba(0, 0, 0, 0.15);
  }

  body.light-mode .btn-secondary:hover {
    background: rgba(0, 0, 0, 0.1);
  }

  .btn-icon {
    font-size: 1.1rem;
  }

  .form-error,
  .form-success {
    padding: 1rem;
    border-radius: 10px;
    margin-top: 1rem;
    display: none;
  }

  .form-error {
    background: rgba(231, 76, 60, 0.1);
    border: 1px solid rgba(231, 76, 60, 0.3);
    color: #ff6b6b;
  }

  .form-error.show {
    display: block;
  }

  .form-success {
    background: rgba(46, 213, 115, 0.1);
    border: 1px solid rgba(46, 213, 115, 0.3);
    color: #2ed573;
  }

  .form-success.show {
    display: block;
  }

  .payment-info {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  body.light-mode .payment-info {
    border-top-color: rgba(0, 0, 0, 0.1);
  }

  .payment-note {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: 0.75rem;
  }

  body.light-mode .payment-note {
    color: rgba(0, 0, 0, 0.6);
  }

  .payment-note a {
    color: #e74c3c;
    text-decoration: none;
  }

  .payment-note a:hover {
    text-decoration: underline;
  }

  @media (max-width: 1024px) {
    .checkout-content {
      grid-template-columns: 1fr;
    }

    .order-summary-section {
      position: static;
      order: 2;
    }

    .checkout-form-section {
      order: 1;
    }
  }

  @media (max-width: 768px) {
    .checkout-container {
      padding: 2rem 1.5rem;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .form-actions {
      flex-direction: column;
    }

    .order-summary-section,
    .checkout-form-section {
      padding: 1.5rem;
    }
  }
</style>

<script is:inline>
  // Load cart data
  function loadCheckoutCart() {
    const saved = localStorage.getItem('checkmyrental_cart');
    if (saved) {
      return JSON.parse(saved);
    }
    return [];
  }

  // Calculate totals
  function calculateTotals(cart) {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const tax = subtotal * 0.07; // 7% estimated tax
    const total = subtotal + tax;
    return { subtotal, tax, total };
  }

  // Render checkout items
  function renderCheckoutItems() {
    const cart = loadCheckoutCart();
    const checkoutItems = document.getElementById('checkout-items');
    const emptyMessage = document.getElementById('empty-cart-message');
    const orderTotals = document.getElementById('order-totals');

    if (cart.length === 0) {
      checkoutItems.style.display = 'none';
      orderTotals.classList.remove('show');
      emptyMessage.classList.add('show');
      return;
    }

    emptyMessage.classList.remove('show');
    checkoutItems.style.display = 'flex';
    orderTotals.classList.add('show');

    // Render cart items
    checkoutItems.innerHTML = cart.map(item => `
      <div class="checkout-item">
        <div class="checkout-item-header">
          <div class="checkout-item-title">${item.title}</div>
          <div class="checkout-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
        </div>
        ${item.description ? `<div class="checkout-item-description">${item.description}</div>` : ''}
        <div class="checkout-item-quantity">Quantity: ${item.quantity}</div>
      </div>
    `).join('');

    // Calculate and display totals
    const { subtotal, tax, total } = calculateTotals(cart);
    document.getElementById('checkout-subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('checkout-tax').textContent = `$${tax.toFixed(2)}`;
    document.getElementById('checkout-total').textContent = `$${total.toFixed(2)}`;
  }

  // Handle form submission
  function handleCheckoutSubmit(e) {
    e.preventDefault();

    const formError = document.getElementById('form-error');
    const formSuccess = document.getElementById('form-success');
    const submitBtn = e.target.querySelector('button[type="submit"]');

    // Clear previous messages
    formError.classList.remove('show');
    formSuccess.classList.remove('show');

    // Get cart data
    const cart = loadCheckoutCart();
    if (cart.length === 0) {
      formError.textContent = 'Your cart is empty. Please add items before checkout.';
      formError.classList.add('show');
      return;
    }

    // Get form data
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    // Add cart items to submission
    data.cart_items = cart;
    data.totals = calculateTotals(cart);

    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';

    // TODO: Send to backend API
    // For now, simulate success
    setTimeout(() => {
      formSuccess.innerHTML = `
        <strong>Order Received!</strong><br>
        Thank you for your order. We'll contact you within 24 hours to confirm your inspection appointment and send a secure payment link.<br>
        <br>
        A confirmation has been sent to <strong>${data.email}</strong>
      `;
      formSuccess.classList.add('show');

      // Clear cart
      localStorage.removeItem('checkmyrental_cart');

      // Reset form
      e.target.reset();
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span class="btn-icon">ðŸ”’</span> Complete Order';

      // Update display
      setTimeout(() => {
        window.location.href = '/';
      }, 5000);
    }, 1500);
  }

  // Set minimum date to tomorrow
  function setMinDate() {
    const dateInput = document.getElementById('preferred-date');
    if (dateInput) {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 2); // At least 48 hours in advance
      dateInput.min = tomorrow.toISOString().split('T')[0];
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    renderCheckoutItems();
    setMinDate();

    const form = document.getElementById('checkout-form');
    if (form) {
      form.addEventListener('submit', handleCheckoutSubmit);
    }
  });
</script>
